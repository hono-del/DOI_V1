<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–æ‰±èª¬æ˜æ›¸DX - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¬ã‚¤ãƒ‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .mobile-frame {
            max-width: 375px;
            margin: 20px auto;
            border: 8px solid #2d3561;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8), 0 0 20px rgba(79, 172, 254, 0.2);
            background: #0f3460;
            height: 667px;
            display: flex;
            flex-direction: column;
        }

        .mobile-header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            color: #4facfe;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
        }

        .mobile-header h2 {
            font-size: 1.1em;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85em;
            color: #4ade80;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #chatContainer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            scroll-behavior: smooth;
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .chat-avatar.ai {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .chat-avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.95em;
            line-height: 1.5;
        }

        .chat-bubble.ai {
            background: rgba(45, 53, 97, 0.8);
            border: 1px solid rgba(79, 172, 254, 0.3);
            color: #e0e0e0;
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-bubble strong {
            color: #4facfe;
            display: block;
            margin-bottom: 8px;
        }

        .guide-link {
            display: inline-block;
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            padding: 6px 12px;
            border-radius: 8px;
            margin: 8px 4px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            border: 1px solid rgba(79, 172, 254, 0.4);
            transition: all 0.3s;
        }

        .guide-link:hover {
            background: rgba(79, 172, 254, 0.3);
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .action-button {
            display: inline-block;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #0f3460;
            padding: 8px 16px;
            border-radius: 12px;
            margin: 8px 4px 0 0;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .quick-reply-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-reply {
            background: rgba(79, 172, 254, 0.1);
            color: #4facfe;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            border: 1px solid rgba(79, 172, 254, 0.3);
            transition: all 0.3s;
        }

        .quick-reply:hover {
            background: rgba(79, 172, 254, 0.2);
            border-color: #4facfe;
            transform: translateY(-2px);
        }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(45, 53, 97, 0.6);
            border-radius: 18px;
            width: fit-content;
        }

        .loading-indicator.active {
            display: flex;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #4facfe;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #chatInputContainer {
            background: #0f3460;
            padding: 15px;
            border-top: 1px solid rgba(79, 172, 254, 0.3);
        }

        #chatInput {
            flex: 1;
            background: rgba(45, 53, 97, 0.6);
            color: #e0e0e0;
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 12px;
            padding: 12px;
            font-size: 0.95em;
            resize: none;
            min-height: 45px;
            max-height: 100px;
            font-family: inherit;
            width: 100%;
        }

        #chatInput:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .send-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #0f3460;
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            height: 45px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-hint {
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #16213e;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid rgba(79, 172, 254, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(79, 172, 254, 0.3);
        }

        .modal-title {
            font-size: 1.3em;
            color: #4facfe;
            font-weight: 600;
        }

        .modal-close {
            font-size: 1.5em;
            cursor: pointer;
            color: #888;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: #4facfe;
        }

        .guide-step {
            background: rgba(45, 53, 97, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            border-left: 3px solid #4facfe;
        }

        .guide-step-number {
            color: #4facfe;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .guide-warning {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid #ef4444;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            color: #fca5a5;
        }

        .guide-tip {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid #22c55e;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            color: #86efac;
        }

        .store-card {
            background: rgba(45, 53, 97, 0.6);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }

        .store-name {
            color: #4facfe;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .store-info {
            font-size: 0.9em;
            color: #b0b0b0;
            line-height: 1.8;
        }

        .flow-visualization {
            background: rgba(45, 53, 97, 0.4);
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            border: 1px solid rgba(79, 172, 254, 0.2);
        }

        .flow-node {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            font-size: 0.9em;
        }

        .flow-arrow {
            color: #4facfe;
        }

        .flow-current {
            background: rgba(79, 172, 254, 0.2);
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid #4facfe;
        }
    </style>
</head>
<body>
    <div class="mobile-frame">
        <div class="mobile-header">
            <h2>ğŸ¤– AIã‚¬ã‚¤ãƒ‰ - THEME-001</h2>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span id="statusText">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
            </div>
        </div>

        <div id="chatContainer"></div>

        <div id="chatInputContainer">
            <div class="input-wrapper">
                <textarea 
                    id="chatInput" 
                    placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." 
                    rows="1"
                    onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    <span>é€ä¿¡</span>
                    <span>ğŸ“¤</span>
                </button>
            </div>
            <div class="input-hint">
                ğŸ’¡ Shift+Enterã§æ”¹è¡Œ | ç¾åœ¨åœ°: <span id="currentNodeLabel">START</span>
            </div>
        </div>
    </div>

    <!-- ã‚¬ã‚¤ãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="guideModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <div class="modal-close" onclick="closeModal()">Ã—</div>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // è¨­å®š
        const GUIDE_CONTENT_PATH = '../docs/journey/csv_data/guide_content/';
        const API_BASE_URL = 'http://localhost:5000/api';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
        let chatHistory = [];
        let currentFlow = {
            theme: 'THEME-001',
            currentNode: 'NODE-START',
            context: {
                hasIndicator: null,
                hasBattery: null,
                preferredAction: null
            }
        };
        let guidesCache = {};

        // åˆæœŸåŒ–
        window.onload = function() {
            initializeChat();
            preloadGuides();
        };

        function initializeChat() {
            showWelcomeMessage();
        }

        async function preloadGuides() {
            // ã‚ˆãä½¿ã†ã‚¬ã‚¤ãƒ‰ã‚’äº‹å‰èª­ã¿è¾¼ã¿
            const commonGuides = ['GUIDE-001', 'GUIDE-003', 'GUIDE-004', 'GUIDE-005', 'GUIDE-008'];
            for (const guideId of commonGuides) {
                await loadGuideContent(guideId);
            }
        }

        async function loadGuideContent(guideId) {
            if (guidesCache[guideId]) {
                return guidesCache[guideId];
            }
            
            try {
                const response = await fetch(`${GUIDE_CONTENT_PATH}${guideId}_content.json`);
                const guide = await response.json();
                guidesCache[guideId] = guide;
                return guide;
            } catch (error) {
                console.error(`Failed to load ${guideId}:`, error);
                return null;
            }
        }

        function showWelcomeMessage() {
            addMessage('ai', `ã“ã‚“ã«ã¡ã¯!ãƒˆãƒ¨ã‚¿è»Šå–æ‰±èª¬æ˜æ›¸AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ğŸš—

ãŠå›°ã‚Šã®ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ã€‚

<div class="quick-reply-container">
    <div class="quick-reply" onclick="startSmartKeyFlow()">ğŸ”‘ ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã§ãƒ‰ã‚¢ãŒé–‹ã‹ãªã„</div>
    <div class="quick-reply" onclick="handleQuickReply('é›»æ± äº¤æ›ã®æ–¹æ³•')">ğŸ”‹ é›»æ± äº¤æ›ã®æ–¹æ³•</div>
    <div class="quick-reply" onclick="handleQuickReply('æ©Ÿæ¢°ã‚­ãƒ¼ã®ä½¿ã„æ–¹')">ğŸ”§ æ©Ÿæ¢°ã‚­ãƒ¼ã®ä½¿ã„æ–¹</div>
</div>`, false);
        }

        function handleQuickReply(message) {
            sendMessage(message);
        }

        async function sendMessage(predefinedMessage) {
            const input = document.getElementById('chatInput');
            const message = predefinedMessage || input.value.trim();
            
            if (!message) return;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage('user', message);
            
            if (!predefinedMessage) {
                input.value = '';
            }
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            showLoading();
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
            await processMessage(message);
            
            hideLoading();
        }

        async function processMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼') || lowerMessage.includes('ãƒ‰ã‚¢') || lowerMessage.includes('é–‹ã‹ãªã„')) {
                await startSmartKeyFlow();
            } else if (lowerMessage.includes('é›»æ± äº¤æ›')) {
                await handleBatteryReplacement();
            } else if (lowerMessage.includes('æ©Ÿæ¢°ã‚­ãƒ¼')) {
                await showGuideInteractive('GUIDE-001');
            } else {
                handleGenericQuery(message);
            }
        }

        async function startSmartKeyFlow() {
            updateNodeLabel('ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç¢ºèª');
            
            addMessage('ai', `<strong>ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã§ãƒ‰ã‚¢ãŒé–‹ã‹ãªã„çŠ¶æ³ã§ã™ã­</strong>

THEME-001ã®ãƒ•ãƒ­ãƒ¼ã§è¨ºæ–­ã—ã¾ã™ã€‚

<div class="flow-visualization">
    <div class="flow-node"><span class="flow-arrow">â–¶</span> START: å•é¡Œç™ºç”Ÿ</div>
    <div class="flow-node flow-current"><span class="flow-arrow">â–¶</span> CHECK-001: ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç¢ºèª</div>
    <div class="flow-node"><span class="flow-arrow">â–¶</span> æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—...</div>
</div>

ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã€ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãƒ©ãƒ³ãƒ—ï¼ˆå°ã•ãªèµ¤ã„ãƒ©ãƒ³ãƒ—ï¼‰ã¯ç‚¹ç¯ã—ã¾ã™ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleIndicatorCheck('yes')">âœ… ã¯ã„ã€ç‚¹ç¯ã—ã¾ã™</div>
    <div class="quick-reply" onclick="handleIndicatorCheck('no')">âŒ ã„ã„ãˆã€ç‚¹ç¯ã—ã¾ã›ã‚“</div>
    <div class="quick-reply" onclick="handleIndicatorCheck('unknown')">â“ ã‚ã‹ã‚Šã¾ã›ã‚“</div>
</div>`, false);
            
            currentFlow.currentNode = 'CHECK-001';
        }

        async function handleIndicatorCheck(response) {
            currentFlow.context.hasIndicator = response === 'yes';
            
            if (response === 'yes') {
                addMessage('user', 'ã¯ã„ã€ç‚¹ç¯ã—ã¾ã™');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                updateNodeLabel('é›»æ³¢å¹²æ¸‰ç¢ºèª');
                handleElectricInterference();
            } else if (response === 'no') {
                addMessage('user', 'ã„ã„ãˆã€ç‚¹ç¯ã—ã¾ã›ã‚“');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                updateNodeLabel('é›»æ± äº¤æ›ææ¡ˆ');
                await handleBatteryIssue();
            } else {
                addMessage('user', 'ã‚ã‹ã‚Šã¾ã›ã‚“');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                showIndicatorCheckGuide();
            }
        }

        async function handleBatteryIssue() {
            currentFlow.currentNode = 'NODE-BATTERY-DEAD';
            
            const guide001 = await loadGuideContent('GUIDE-001');
            
            addMessage('ai', `<strong>é›»æ± åˆ‡ã‚Œã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ ğŸ”‹</strong>

<div class="flow-visualization">
    <div class="flow-node">âœ“ CHECK-001: ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç¢ºèªæ¸ˆã¿</div>
    <div class="flow-node flow-current"><span class="flow-arrow">â–¶</span> NODE-BATTERY-DEAD: é›»æ± åˆ‡ã‚Œå¯¾å¿œ</div>
</div>

<strong>ä»Šã™ãã§ãã‚‹å¯¾å¿œ:</strong>

<div class="guide-link" onclick="showGuideInteractive('GUIDE-001')">ğŸ“– æ©Ÿæ¢°ã‚­ãƒ¼ã®å–ã‚Šå‡ºã—æ–¹ (1åˆ†)</div>

${guide001 ? `<small>æ©Ÿæ¢°ã‚­ãƒ¼ã‚’ä½¿ãˆã°ã€é›»æ± äº¤æ›ãªã—ã§ä»Šã™ããƒ‰ã‚¢ã‚’é–‹ã‘ã‚‰ã‚Œã¾ã™ã€‚</small>` : ''}

<strong>é›»æ± äº¤æ›ã«ã¤ã„ã¦:</strong>

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„:

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleBatteryChoice('diy')">ğŸ”§ è‡ªåˆ†ã§äº¤æ›ã™ã‚‹</div>
    <div class="quick-reply" onclick="handleBatteryChoice('dealer')">ğŸš— è²©å£²åº—ã«ä¾é ¼ã™ã‚‹</div>
</div>`, false);
        }

        async function handleBatteryChoice(choice) {
            currentFlow.context.preferredAction = choice;
            
            if (choice === 'diy') {
                addMessage('user', 'è‡ªåˆ†ã§äº¤æ›ã™ã‚‹');
                updateNodeLabel('DIYé›»æ± äº¤æ›');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                await showDIYBatteryFlow();
            } else {
                addMessage('user', 'è²©å£²åº—ã«ä¾é ¼ã™ã‚‹');
                updateNodeLabel('è²©å£²åº—æ¤œç´¢');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 1000));
                hideLoading();
                await findDealers();
            }
        }

        async function showDIYBatteryFlow() {
            const guide003 = await loadGuideContent('GUIDE-003');
            const guide005 = await loadGuideContent('GUIDE-005');
            
            addMessage('ai', `<strong>è‡ªåˆ†ã§é›»æ± äº¤æ›ã™ã‚‹æ‰‹é †</strong>

<div class="flow-visualization">
    <div class="flow-node flow-current"><span class="flow-arrow">â–¶</span> NODE-DIY-CHECK: æº–å‚™ç‰©ç¢ºèª</div>
    <div class="flow-node"><span class="flow-arrow">â–¶</span> NODE-DIY-EXECUTE: äº¤æ›å®Ÿè¡Œ</div>
</div>

<div class="guide-warning">
âš ï¸ æ³¨æ„: éƒ¨å“ãŒç ´æã™ã‚‹ãŠãã‚ŒãŒã‚ã‚‹ãŸã‚ã€ãƒˆãƒ¨ã‚¿è²©å£²åº—ã§ã®äº¤æ›ã‚’ãŠã™ã™ã‚ã—ã¾ã™
</div>

å¿…è¦ãªã‚‚ã®:
â€¢ ãƒã‚¤ãƒŠã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ï¼ˆä¸­ã‚µã‚¤ã‚ºï¼‰
â€¢ å°ã•ã„ãƒã‚¤ãƒŠã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼
â€¢ ãƒªãƒã‚¦ãƒ é›»æ±  CR2450

<div class="guide-link" onclick="showGuideInteractive('GUIDE-003')">ğŸ“‹ æº–å‚™ç‰©ã®è©³ç´°</div>
<div class="guide-link" onclick="showGuideInteractive('GUIDE-005')">ğŸ“– äº¤æ›æ‰‹é †ï¼ˆ7ã‚¹ãƒ†ãƒƒãƒ—ï¼‰</div>

æº–å‚™ç‰©ã¯æƒã£ã¦ã„ã¾ã™ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handlePreparationCheck('ready')">âœ… æƒã£ã¦ã„ã¾ã™</div>
    <div class="quick-reply" onclick="handlePreparationCheck('need-battery')">ğŸ”‹ é›»æ± ãŒå¿…è¦ã§ã™</div>
    <div class="quick-reply" onclick="handlePreparationCheck('need-tools')">ğŸ”§ é“å…·ãŒå¿…è¦ã§ã™</div>
</div>`, false);
        }

        async function handlePreparationCheck(status) {
            if (status === 'ready') {
                addMessage('user', 'æº–å‚™ç‰©ã¯æƒã£ã¦ã„ã¾ã™');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 800));
                hideLoading();
                await showBatteryReplacementGuide();
            } else if (status === 'need-battery') {
                addMessage('user', 'é›»æ± ãŒå¿…è¦ã§ã™');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 800));
                hideLoading();
                await findNearbyStores();
            } else {
                addMessage('user', 'é“å…·ãŒå¿…è¦ã§ã™');
                showLoading();
                await new Promise(resolve => setTimeout(resolve, 800));
                hideLoading();
                showToolsPurchaseGuide();
            }
        }

        async function showBatteryReplacementGuide() {
            const guide005 = await loadGuideContent('GUIDE-005');
            
            if (guide005) {
                let stepsHtml = '<strong>é›»æ± äº¤æ›æ‰‹é †</strong><br><br>';
                
                if (guide005.content.important_notice) {
                    stepsHtml += `<div class="guide-warning">âš ï¸ ${guide005.content.important_notice.message}</div>`;
                }
                
                guide005.content.steps.forEach((step, index) => {
                    stepsHtml += `<strong>${step.step}. ${step.description}</strong><br>`;
                    if (step.detail) {
                        stepsHtml += `<small>${step.detail}</small><br>`;
                    }
                    if (step.caution) {
                        stepsHtml += `<small style="color: #fca5a5;">âš ï¸ ${step.caution}</small><br>`;
                    }
                    stepsHtml += '<br>';
                });
                
                stepsHtml += '<div class="action-button" onclick="confirmBatteryReplacement()">âœ… äº¤æ›å®Œäº†ã—ã¾ã—ãŸ</div>';
                stepsHtml += '<div class="action-button" onclick="showGuideInteractive(\'GUIDE-005\')">ğŸ“– è©³ç´°ã‚’è¦‹ã‚‹</div>';
                
                addMessage('ai', stepsHtml, false);
            }
        }

        function confirmBatteryReplacement() {
            addMessage('user', 'äº¤æ›å®Œäº†ã—ã¾ã—ãŸ');
            updateNodeLabel('å‹•ä½œç¢ºèª');
            
            addMessage('ai', `<strong>ãŠç–²ã‚Œæ§˜ã§ã—ãŸ! ğŸ‰</strong>

é›»æ± äº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸã­ã€‚å‹•ä½œç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ã€‚

<strong>ç¢ºèªé …ç›®:</strong>
1. ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒç‚¹ç¯ã™ã‚‹ã‹
2. è»Šä¸¡ã®ãƒ‰ã‚¢ãƒ­ãƒƒã‚¯/ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹

å‹•ä½œã¯æ­£å¸¸ã§ã™ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleOperationCheck('success')">âœ… æ­£å¸¸ã«å‹•ä½œã—ã¾ã™</div>
    <div class="quick-reply" onclick="handleOperationCheck('failed')">âŒ ã¾ã å‹•ä½œã—ã¾ã›ã‚“</div>
</div>`, false);
        }

        function handleOperationCheck(result) {
            if (result === 'success') {
                addMessage('user', 'æ­£å¸¸ã«å‹•ä½œã—ã¾ã™');
                updateNodeLabel('è§£æ±º');
                
                addMessage('ai', `<strong>å•é¡ŒãŒè§£æ±ºã—ã¾ã—ãŸ! ğŸŠ</strong>

<div class="flow-visualization">
    <div class="flow-node">âœ“ é›»æ± äº¤æ›å®Œäº†</div>
    <div class="flow-node">âœ“ å‹•ä½œç¢ºèªOK</div>
    <div class="flow-node flow-current"><span class="flow-arrow">â–¶</span> è§£æ±º!</div>
</div>

ä»Šå¾Œã®äºˆé˜²ç­–ã¨ã—ã¦ã€ä»¥ä¸‹ã®ã‚¬ã‚¤ãƒ‰ã‚‚ã”å‚ç…§ãã ã•ã„:

<div class="guide-link" onclick="showGuideInteractive('GUIDE-013')">ğŸ“… äºˆé˜²ç­–ãƒ»å®šæœŸç‚¹æ¤œã®æ¡ˆå†…</div>

<div class="guide-tip">
âœ… é›»æ± ã®å¯¿å‘½: ç´„2-3å¹´<br>
âœ… äºˆé˜²äº¤æ›: 2å¹´ã”ã¨ãŒãŠã™ã™ã‚<br>
âœ… äºˆå‚™ã‚­ãƒ¼ã‚‚ç¢ºèªã—ã¾ã—ã‚‡ã†
</div>

ä»–ã«ãŠå›°ã‚Šã®ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹?`, false);
            } else {
                addMessage('user', 'ã¾ã å‹•ä½œã—ã¾ã›ã‚“');
                
                addMessage('ai', `<strong>ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</strong>

é›»æ± äº¤æ›å¾Œã‚‚å‹•ä½œã—ãªã„å ´åˆ:

<strong>ç¢ºèªäº‹é …:</strong>
â€¢ é›»æ± ã®å‘ãï¼ˆ+/-ï¼‰ã¯æ­£ã—ã„ã§ã™ã‹?
â€¢ ã‚«ãƒãƒ¼ã¯ã—ã£ã‹ã‚Šé–‰ã¾ã£ã¦ã„ã¾ã™ã‹?
â€¢ æ–°ã—ã„é›»æ± ã‚’ä½¿ç”¨ã—ã¾ã—ãŸã‹?

ãã‚Œã§ã‚‚æ”¹å–„ã—ãªã„å ´åˆã¯ã€ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼æœ¬ä½“ã®æ•…éšœã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

<div class="action-button" onclick="findDealers()">ğŸš— è²©å£²åº—ã§ç‚¹æ¤œã—ã¦ã‚‚ã‚‰ã†</div>
<div class="guide-link" onclick="showGuideInteractive('GUIDE-009')">ğŸ“– ã‚­ãƒ¼ä¿®ç†ãƒ»äº¤æ›æ‰‹ç¶šã</div>`, false);
            }
        }

        async function findNearbyStores() {
            updateNodeLabel('é›»æ± è³¼å…¥ã‚µãƒãƒ¼ãƒˆ');
            
            // å…ˆã«ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’å³æ™‚è¡¨ç¤ºã—ã¦å¾…ã¡æ™‚é–“ã‚’ãªãã™
            addMessage('ai', `<strong>CR2450é›»æ± ã®è³¼å…¥æ–¹æ³•</strong>

ã¾ãšã¯ç›®å®‰ã¨ã—ã¦ã€ä»£è¡¨çš„ãªåº—èˆ—å€™è£œã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚`, false);
            displayNearbyStoresDemo();
            
            // ãã®å¾Œã€ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¾åœ¨åœ°ãƒ™ãƒ¼ã‚¹ã®æ¤œç´¢ã‚’è©¦ã¿ã‚‹
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        await fetchNearbyStores(position.coords.latitude, position.coords.longitude);
                    },
                    () => {
                        // ä½ç½®æƒ…å ±ãŒæ‹’å¦/å¤±æ•—ã—ã¦ã‚‚ã€ãƒ‡ãƒ¢è¡¨ç¤ºãŒã‚ã‚‹ã®ã§ä½•ã‚‚ã—ãªã„
                        console.warn('ä½ç½®æƒ…å ±ãŒå–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’è¡¨ç¤ºã—ã¾ã™');
                    }
                );
            }
        }

        async function fetchNearbyStores(latitude, longitude) {
            try {
                const response = await fetch(`${API_BASE_URL}/nearby-stores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { latitude, longitude },
                        item: 'CR2450',
                        radius_km: 5
                    })
                });
                
                const data = await response.json();
                
                // ä½ç½®æƒ…å ±ã‚’ä½¿ã£ãŸçµæœãŒå¾—ã‚‰ã‚ŒãŸã‚‰ã€ã€Œç¾åœ¨åœ°ã«åŸºã¥ãå€™è£œã€ã¨ã—ã¦è¿½åŠ è¡¨ç¤º
                if (data && data.stores && data.stores.length > 0) {
                    addMessage('ai', '<strong>ç¾åœ¨åœ°ã«åŸºã¥ãå€™è£œ</strong><br>å…ˆã»ã©ã®ç›®å®‰ã«åŠ ãˆã¦ã€ç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„åº—èˆ—ã‚‚ã”æ¡ˆå†…ã—ã¾ã™ã€‚', false);
                    displayNearbyStores(data.stores);
                }
            } catch (error) {
                console.error('API Error:', error);
                // ã™ã§ã«ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
            }
        }

        function displayNearbyStoresDemo() {
            const storesHtml = `<strong>è¿‘éš£ã®åº—èˆ—ï¼ˆ5kmåœå†…ï¼‰</strong>

<div class="store-card">
    <div class="store-name">1. ãƒ¨ãƒ‰ãƒã‚·ã‚«ãƒ¡ãƒ© æ–°å®¿è¥¿å£æœ¬åº—</div>
    <div class="store-info">
        ğŸ“ è·é›¢: 1.2km<br>
        ğŸª åœ¨åº«: é«˜ç¢ºç‡ã§ã‚ã‚Š<br>
        ğŸ“ 03-3346-1010<br>
        â° 9:30-22:00ï¼ˆå¹´ä¸­ç„¡ä¼‘ï¼‰
    </div>
</div>

<div class="store-card">
    <div class="store-name">2. ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ© æ¸‹è°·æ±å£åº—</div>
    <div class="store-info">
        ğŸ“ è·é›¢: 2.5km<br>
        ğŸª åœ¨åº«: é«˜ç¢ºç‡ã§ã‚ã‚Š<br>
        ğŸ“ 03-5466-1111<br>
        â° 10:00-21:00
    </div>
</div>

<div class="store-card">
    <div class="store-name">3. ã‚»ã‚¤ã‚³ãƒ¼ã‚¦ã‚©ãƒƒãƒã‚µãƒ­ãƒ³ éŠ€åº§</div>
    <div class="store-info">
        ğŸ“ è·é›¢: 3.1km<br>
        ğŸª åœ¨åº«: é«˜ç¢ºç‡ã§ã‚ã‚Š<br>
        ğŸ“ 03-3563-1111<br>
        â° 11:00-19:30
    </div>
</div>

<div class="guide-tip">
ğŸ’¡ æ¥åº—å‰ã«é›»è©±ã§åœ¨åº«ç¢ºèªã‚’ãŠã™ã™ã‚ã—ã¾ã™<br>
ğŸ’¡ ä¾¡æ ¼: Â¥200-500ç¨‹åº¦
</div>

<strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è³¼å…¥:</strong>
<div class="action-button" onclick="window.open('https://amazon.co.jp/s?k=CR2450', '_blank')">ğŸ›’ Amazonã§è³¼å…¥</div>
<div class="action-button" onclick="window.open('https://search.rakuten.co.jp/search?k=CR2450', '_blank')">ğŸ›’ æ¥½å¤©ã§è³¼å…¥</div>

<div class="guide-link" onclick="showGuideInteractive('GUIDE-004')">ğŸ“– è³¼å…¥æ–¹æ³•ã®è©³ç´°</div>`;
            
            addMessage('ai', storesHtml, false);
        }

        function displayNearbyStores(stores) {
            if (!stores || stores.length === 0) {
                displayNearbyStoresDemo();
                return;
            }
            
            let storesHtml = '<strong>è¿‘éš£ã®åº—èˆ—</strong><br><br>';
            
            stores.slice(0, 3).forEach((store, index) => {
                storesHtml += `<div class="store-card">`;
                storesHtml += `<div class="store-name">${index + 1}. ${store.name}</div>`;
                storesHtml += `<div class="store-info">`;
                storesHtml += `ğŸ“ è·é›¢: ${store.distance_km}km<br>`;
                storesHtml += `ğŸª åœ¨åº«: ${store.battery_availability?.availability || 'è¦ç¢ºèª'}<br>`;
                if (store.contact?.phone) {
                    storesHtml += `ğŸ“ ${store.contact.phone}<br>`;
                }
                if (store.business_hours) {
                    storesHtml += `â° ${store.business_hours.weekday || 'å–¶æ¥­æ™‚é–“è¦ç¢ºèª'}`;
                }
                storesHtml += `</div></div>`;
            });
            
            addMessage('ai', storesHtml, false);
        }

        async function findDealers() {
            updateNodeLabel('è²©å£²åº—äºˆç´„');
            
            addMessage('ai', `<strong>ãƒˆãƒ¨ã‚¿è²©å£²åº—ã‚’æ¢ã—ã¾ã™</strong>

è¿‘ãã®è²©å£²åº—ã‚’æ¤œç´¢ä¸­...`, false);
            
            showLoading();
            await new Promise(resolve => setTimeout(resolve, 1000));
            hideLoading();
            
            displayDealersDemo();
        }

        function displayDealersDemo() {
            const dealersHtml = `<strong>è¿‘ãã®ãƒˆãƒ¨ã‚¿è²©å£²åº—</strong>

é›»æ± äº¤æ›ã‚µãƒ¼ãƒ“ã‚¹ã‚’æä¾›ã—ã¦ã„ã‚‹è²©å£²åº—ã§ã™:

<div class="store-card">
    <div class="store-name">1. ãƒˆãƒ¨ã‚¿æ±äº¬ã‚«ãƒ­ãƒ¼ãƒ© æ–°å®¿åº—</div>
    <div class="store-info">
        ğŸ“ è·é›¢: 2.3km<br>
        â° ã‚µãƒ¼ãƒ“ã‚¹: å¹³æ—¥ 9:00-18:00 / åœŸ 9:00-17:00<br>
        ğŸ“ 03-3363-5111<br>
        âœ… é›»æ± äº¤æ›ã€ã‚­ãƒ¼ä¿®ç†ã€ç‚¹æ¤œã€è»Šæ¤œ
    </div>
    <div class="action-button" onclick="showReservationForm('DEALER-001', 'ãƒˆãƒ¨ã‚¿æ±äº¬ã‚«ãƒ­ãƒ¼ãƒ© æ–°å®¿åº—')">ğŸ“… ã“ã®åº—èˆ—ã‚’äºˆç´„</div>
</div>

<div class="store-card">
    <div class="store-name">2. ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©æ±äº¬ æ¸‹è°·åº—</div>
    <div class="store-info">
        ğŸ“ è·é›¢: 3.5km<br>
        â° ã‚µãƒ¼ãƒ“ã‚¹: æ¯æ—¥ 9:00-18:00<br>
        ğŸ“ 03-3463-5111<br>
        âœ… é›»æ± äº¤æ›ã€ã‚­ãƒ¼ä¿®ç†ã€ç‚¹æ¤œ
    </div>
    <div class="action-button" onclick="showReservationForm('DEALER-002', 'ãƒˆãƒ¨ã‚¿ã‚«ãƒ­ãƒ¼ãƒ©æ±äº¬ æ¸‹è°·åº—')">ğŸ“… ã“ã®åº—èˆ—ã‚’äºˆç´„</div>
</div>

<div class="guide-tip">
ğŸ’¡ æ‰€è¦æ™‚é–“: 10-15åˆ†<br>
ğŸ’¡ äºˆç´„ãªã—ã§ã‚‚å¯¾å¿œå¯èƒ½ã§ã™ãŒã€äºˆç´„ã§å¾…ã¡æ™‚é–“çŸ­ç¸®<br>
ğŸ’¡ è²»ç”¨: åº—èˆ—ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„
</div>

<div class="guide-link" onclick="showGuideInteractive('GUIDE-006')">ğŸ“– äºˆç´„æ–¹æ³•ã®è©³ç´°</div>`;
            
            addMessage('ai', dealersHtml, false);
        }

        function showReservationForm(dealerId, dealerName) {
            const formHtml = `<strong>äºˆç´„ãƒ•ã‚©ãƒ¼ãƒ : ${dealerName}</strong>

<div style="background: rgba(45, 53, 97, 0.6); padding: 15px; border-radius: 12px; margin: 15px 0;">
    <strong>ã‚µãƒ¼ãƒ“ã‚¹:</strong> é›»æ± äº¤æ›<br>
    <strong>è²©å£²åº—:</strong> ${dealerName}<br><br>
    
    <div style="margin: 10px 0;">
        <strong>å¸Œæœ›æ—¥:</strong><br>
        <input type="date" id="reserveDate" min="${getTodayDate()}" 
               style="background: #1a1a2e; color: #e0e0e0; border: 1px solid #4facfe; padding: 8px; border-radius: 8px; width: 100%;">
    </div>
    
    <div style="margin: 10px 0;">
        <strong>å¸Œæœ›æ™‚åˆ»:</strong><br>
        <select id="reserveTime" style="background: #1a1a2e; color: #e0e0e0; border: 1px solid #4facfe; padding: 8px; border-radius: 8px; width: 100%;">
            <option value="10:00">10:00</option>
            <option value="11:00">11:00</option>
            <option value="14:00">14:00</option>
            <option value="15:00">15:00</option>
            <option value="16:00">16:00</option>
        </select>
    </div>
    
    <div style="margin: 10px 0;">
        <strong>ãŠåå‰:</strong><br>
        <input type="text" id="customerName" placeholder="å±±ç”°å¤ªéƒ"
               style="background: #1a1a2e; color: #e0e0e0; border: 1px solid #4facfe; padding: 8px; border-radius: 8px; width: 100%;">
    </div>
    
    <div style="margin: 10px 0;">
        <strong>é›»è©±ç•ªå·:</strong><br>
        <input type="tel" id="customerPhone" placeholder="090-1234-5678"
               style="background: #1a1a2e; color: #e0e0e0; border: 1px solid #4facfe; padding: 8px; border-radius: 8px; width: 100%;">
    </div>
</div>

<div class="action-button" onclick="submitReservation('${dealerId}', '${dealerName}')">ğŸ“… äºˆç´„ã‚’ç¢ºå®šã™ã‚‹</div>
<div class="quick-reply" onclick="findDealers()">â† ä»–ã®åº—èˆ—ã‚’è¦‹ã‚‹</div>`;
            
            addMessage('ai', formHtml, false);
        }

        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        async function submitReservation(dealerId, dealerName) {
            const date = document.getElementById('reserveDate')?.value;
            const time = document.getElementById('reserveTime')?.value;
            const name = document.getElementById('customerName')?.value;
            const phone = document.getElementById('customerPhone')?.value;
            
            if (!date || !name || !phone) {
                alert('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            addMessage('user', `äºˆç´„å†…å®¹: ${date} ${time}`);
            showLoading();
            
            // ãƒ‡ãƒ¢: äºˆç´„å‡¦ç†
            await new Promise(resolve => setTimeout(resolve, 1500));
            hideLoading();
            
            const reservationId = 'RES-' + Math.random().toString(36).substr(2, 8).toUpperCase();
            
            addMessage('ai', `<strong>äºˆç´„ãŒå®Œäº†ã—ã¾ã—ãŸ! ğŸ‰</strong>

<div style="background: rgba(34, 197, 94, 0.1); border: 2px solid #22c55e; padding: 15px; border-radius: 12px; margin: 15px 0;">
    <strong style="color: #22c55e;">âœ… äºˆç´„ç¢ºèª</strong><br><br>
    
    <strong>äºˆç´„ç•ªå·:</strong> ${reservationId}<br>
    <strong>è²©å£²åº—:</strong> ${dealerName}<br>
    <strong>æ—¥æ™‚:</strong> ${date} ${time}<br>
    <strong>ã‚µãƒ¼ãƒ“ã‚¹:</strong> é›»æ± äº¤æ›<br>
    <strong>ãŠåå‰:</strong> ${name}<br>
    <strong>é›»è©±:</strong> ${phone}
</div>

<div class="guide-tip">
ğŸ’¡ äºˆç´„ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ<br>
ğŸ’¡ ã”æ¥åº—ã®éš›ã¯ã€ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã‚’ãŠæŒã¡ãã ã•ã„<br>
ğŸ’¡ ã”ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°ã€è²©å£²åº—ã«ãŠé›»è©±ãã ã•ã„
</div>

<strong>å½“æ—¥ã®æµã‚Œ:</strong>
1. äºˆç´„æ™‚åˆ»ã®5-10åˆ†å‰ã«æ¥åº—
2. å—ä»˜ã§ãŠåå‰ã‚’ä¼ãˆã‚‹
3. ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã‚’é ã‘ã‚‹
4. ç´„10-15åˆ†ã§äº¤æ›å®Œäº†
5. å‹•ä½œç¢ºèªã—ã¦å—ã‘å–ã‚Š

å•é¡ŒãŒè§£æ±ºã—ã¾ã—ãŸ! ä»–ã«ãŠå›°ã‚Šã®ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹?`, false);
            
            updateNodeLabel('è§£æ±º');
        }

        function handleElectricInterference() {
            currentFlow.currentNode = 'NODE-INTERFERENCE';
            updateNodeLabel('é›»æ³¢å¹²æ¸‰å¯¾å¿œ');
            
            addMessage('ai', `<strong>é›»æ³¢å¹²æ¸‰ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ ğŸ“¡</strong>

<div class="flow-visualization">
    <div class="flow-node">âœ“ CHECK-001: ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ç‚¹ç¯ç¢ºèªæ¸ˆã¿</div>
    <div class="flow-node flow-current"><span class="flow-arrow">â–¶</span> NODE-INTERFERENCE: é›»æ³¢å¹²æ¸‰å¯¾å¿œ</div>
</div>

ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãŒç‚¹ç¯ã™ã‚‹ã®ã«è»Šä¸¡ãŒåå¿œã—ãªã„å ´åˆã€é›»æ³¢å¹²æ¸‰ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

<strong>å¯¾å‡¦æ³•:</strong>

<strong>1. ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã‚’è»Šä½“ã«è¿‘ã¥ã‘ã‚‹</strong>
ãƒ‰ã‚¢ãƒãƒ³ãƒ‰ãƒ«ã«ç›´æ¥è¿‘ã¥ã‘ã¦æ“ä½œã—ã¦ã¿ã¦ãã ã•ã„

<strong>2. é›»æ³¢å¹²æ¸‰æºã‹ã‚‰é›¢ã‚Œã‚‹</strong>
ç©ºæ¸¯ã€æ”¾é€å±€ã€æºå¸¯åŸºåœ°å±€ã®è¿‘ãã§ã¯é›»æ³¢å¹²æ¸‰ãŒèµ·ã“ã‚Šã‚„ã™ã„ã§ã™

<div class="guide-link" onclick="showGuideInteractive('GUIDE-008')">ğŸ“– é›»æ³¢å¹²æ¸‰æ™‚ã®è©³ã—ã„å¯¾å¿œæ–¹æ³•</div>

è©¦ã—ã¦ã¿ã¦ã‚‚æ”¹å–„ã—ã¾ã›ã‚“ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleInterferenceResolved('yes')">âœ… æ”¹å–„ã—ã¾ã—ãŸ</div>
    <div class="quick-reply" onclick="handleInterferenceResolved('no')">âŒ æ”¹å–„ã—ã¾ã›ã‚“</div>
</div>`, false);
        }

        function handleInterferenceResolved(result) {
            if (result === 'yes') {
                addMessage('user', 'æ”¹å–„ã—ã¾ã—ãŸ');
                updateNodeLabel('è§£æ±º');
                
                addMessage('ai', `<strong>å•é¡ŒãŒè§£æ±ºã—ã¾ã—ãŸ! ğŸŠ</strong>

é›»æ³¢å¹²æ¸‰ãŒåŸå› ã ã£ãŸã‚ˆã†ã§ã™ã­ã€‚

<div class="guide-tip">
ğŸ’¡ ã“ã®ç¾è±¡ã¯ä¸€æ™‚çš„ãªã‚‚ã®ã§ã€æ•…éšœã§ã¯ã‚ã‚Šã¾ã›ã‚“<br>
ğŸ’¡ åŒã˜å ´æ‰€ã§ã¯åŒã˜ç¾è±¡ãŒèµ·ã“ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™<br>
ğŸ’¡ æ©Ÿæ¢°ã‚­ãƒ¼ã®ä½¿ã„æ–¹ã‚’è¦šãˆã¦ãŠãã¨å®‰å¿ƒã§ã™
</div>

<div class="guide-link" onclick="showGuideInteractive('GUIDE-001')">ğŸ“– æ©Ÿæ¢°ã‚­ãƒ¼ã®ä½¿ã„æ–¹</div>

ä»–ã«ãŠå›°ã‚Šã®ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹?`, false);
            } else {
                addMessage('user', 'æ”¹å–„ã—ã¾ã›ã‚“');
                
                addMessage('ai', `<strong>åˆ¥ã®åŸå› ãŒè€ƒãˆã‚‰ã‚Œã¾ã™</strong>

é›»æ³¢å¹²æ¸‰ä»¥å¤–ã®å¯èƒ½æ€§ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†ã€‚

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleBatteryIssue()">ğŸ”‹ é›»æ± åˆ‡ã‚Œã‹ã‚‚ã—ã‚Œãªã„</div>
    <div class="quick-reply" onclick="findDealers()">ğŸš— è²©å£²åº—ã§ç‚¹æ¤œã—ã¦ã‚‚ã‚‰ã†</div>
</div>`, false);
            }
        }

        function showToolsPurchaseGuide() {
            addMessage('ai', `<strong>ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã®è³¼å…¥å ´æ‰€</strong>

ãƒã‚¤ãƒŠã‚¹ãƒ‰ãƒ©ã‚¤ãƒãƒ¼ã¯ä»¥ä¸‹ã®å ´æ‰€ã§è³¼å…¥ã§ãã¾ã™:

â€¢ ãƒ›ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼ï¼ˆã‚³ãƒ¼ãƒŠãƒ³ã€ã‚«ã‚¤ãƒ³ã‚ºãªã©ï¼‰
â€¢ 100å††ã‚·ãƒ§ãƒƒãƒ—ï¼ˆãƒ€ã‚¤ã‚½ãƒ¼ã€ã‚»ãƒªã‚¢ãªã©ï¼‰
â€¢ å®¶é›»é‡è²©åº—
â€¢ ãƒãƒƒãƒˆé€šè²©ï¼ˆAmazonã€æ¥½å¤©ãªã©ï¼‰

<div class="guide-tip">
ğŸ’¡ 100å††ã‚·ãƒ§ãƒƒãƒ—ã§ã‚‚ååˆ†ä½¿ãˆã¾ã™<br>
ğŸ’¡ 2æœ¬ã‚»ãƒƒãƒˆï¼ˆä¸­ã‚µã‚¤ã‚º+å°ã‚µã‚¤ã‚ºï¼‰ãŒãŠã™ã™ã‚
</div>

æº–å‚™ãŒæ•´ã£ãŸã‚‰æ•™ãˆã¦ãã ã•ã„!

<div class="quick-reply" onclick="handlePreparationCheck('ready')">âœ… æº–å‚™ã§ãã¾ã—ãŸ</div>`, false);
        }

        function showIndicatorCheckGuide() {
            addMessage('ai', `<strong>ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ãƒ©ãƒ³ãƒ—ã®ç¢ºèªæ–¹æ³•</strong>

ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã€å°ã•ãªèµ¤ã„ãƒ©ãƒ³ãƒ—ãŒå…‰ã‚‹ã‹ã©ã†ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

<strong>ç¢ºèªæ–¹æ³•:</strong>
1. ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã®ãƒ­ãƒƒã‚¯ãƒœã‚¿ãƒ³ï¼ˆğŸ”’ãƒãƒ¼ã‚¯ï¼‰ã‚’æŠ¼ã™
2. ã‚­ãƒ¼æœ¬ä½“ã‚’è¦‹ã¦ã€å°ã•ãªèµ¤ã„ãƒ©ãƒ³ãƒ—ãŒå…‰ã‚‹ã‹ç¢ºèª
3. æš—ã„å ´æ‰€ã ã¨è¦‹ã‚„ã™ã„ã§ã™

ç¢ºèªã§ãã¾ã—ãŸã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleIndicatorCheck('yes')">âœ… å…‰ã‚Šã¾ã—ãŸ</div>
    <div class="quick-reply" onclick="handleIndicatorCheck('no')">âŒ å…‰ã‚Šã¾ã›ã‚“</div>
</div>`, false);
        }

        async function handleBatteryReplacement() {
            updateNodeLabel('é›»æ± äº¤æ›é¸æŠ');
            
            addMessage('ai', `<strong>é›»æ± äº¤æ›ã®æ–¹æ³•</strong>

é›»æ± äº¤æ›ã«ã¯2ã¤ã®é¸æŠè‚¢ãŒã‚ã‚Šã¾ã™:

<strong>é¸æŠè‚¢1: è‡ªåˆ†ã§äº¤æ›ã™ã‚‹</strong>
â€¢ æ‰€è¦æ™‚é–“: ç´„5åˆ†
â€¢ é›£æ˜“åº¦: â˜…â˜…â˜†â˜†â˜†ï¼ˆãµã¤ã†ï¼‰
â€¢ å¿…è¦ãªã‚‚ã®: ãƒ‰ãƒ©ã‚¤ãƒãƒ¼2æœ¬ã€CR2450é›»æ± 
â€¢ è²»ç”¨: é›»æ± ä»£ã®ã¿ï¼ˆÂ¥200-500ï¼‰

<div class="guide-warning">
âš ï¸ éƒ¨å“ãŒç ´æã™ã‚‹ãŠãã‚ŒãŒã‚ã‚Šã¾ã™
</div>

<strong>é¸æŠè‚¢2: è²©å£²åº—ã§äº¤æ›ã—ã¦ã‚‚ã‚‰ã†ï¼ˆæ¨å¥¨ï¼‰</strong>
â€¢ æ‰€è¦æ™‚é–“: ç´„10-15åˆ†
â€¢ é›£æ˜“åº¦: â˜†â˜†â˜†â˜†â˜†ï¼ˆãŠä»»ã›ï¼‰
â€¢ è²»ç”¨: åº—èˆ—ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„
â€¢ å®‰å…¨ãƒ»ç¢ºå®Ÿ

ã©ã¡ã‚‰ã®æ–¹æ³•ã‚’ãŠé¸ã³ã«ãªã‚Šã¾ã™ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="handleBatteryChoice('diy')">ğŸ”§ è‡ªåˆ†ã§äº¤æ›ã™ã‚‹</div>
    <div class="quick-reply" onclick="handleBatteryChoice('dealer')">ğŸš— è²©å£²åº—ã«ä¾é ¼ã™ã‚‹</div>
</div>`, false);
        }

        async function showGuideInteractive(guideId) {
            const guide = await loadGuideContent(guideId);
            
            if (!guide) {
                alert('ã‚¬ã‚¤ãƒ‰ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            let modalContent = `<div style="color: #b0b0b0; margin-bottom: 15px;">`;
            modalContent += `â±ï¸ æ‰€è¦æ™‚é–“: ${guide.estimated_time || '5min'} | `;
            modalContent += `é›£æ˜“åº¦: ${getDifficultyLabel(guide.difficulty)}`;
            modalContent += `</div>`;
            
            if (guide.content.overview) {
                modalContent += `<p style="margin-bottom: 20px;">${guide.content.overview}</p>`;
            }
            
            // é‡è¦ãªé€šçŸ¥
            if (guide.content.important_notice) {
                modalContent += `<div class="guide-warning">âš ï¸ ${guide.content.important_notice.message}</div>`;
            }
            
            // æ‰‹é †
            if (guide.content.steps) {
                guide.content.steps.forEach(step => {
                    modalContent += `<div class="guide-step">`;
                    modalContent += `<div class="guide-step-number">ã‚¹ãƒ†ãƒƒãƒ— ${step.step}</div>`;
                    modalContent += `${step.description}<br>`;
                    if (step.detail) {
                        modalContent += `<small>${step.detail}</small><br>`;
                    }
                    if (step.caution) {
                        modalContent += `<small style="color: #fca5a5;">âš ï¸ ${step.caution}</small>`;
                    }
                    if (step.note) {
                        modalContent += `<small style="color: #86efac;">ğŸ’¡ ${step.note}</small>`;
                    }
                    modalContent += `</div>`;
                });
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            if (guide.content.checklist) {
                guide.content.checklist.forEach(item => {
                    modalContent += `<div class="guide-step">`;
                    modalContent += `<div class="guide-step-number">${item.required ? 'âœ…' : 'ğŸ’¡'} ${item.item}</div>`;
                    modalContent += `${item.description}`;
                    if (item.size) modalContent += `<br><small>ã‚µã‚¤ã‚º: ${item.size}</small>`;
                    if (item.specifications) modalContent += `<br><small>${item.specifications}</small>`;
                    modalContent += `</div>`;
                });
            }
            
            // è­¦å‘Š
            if (guide.content.warnings) {
                guide.content.warnings.forEach(warning => {
                    modalContent += `<div class="guide-warning">âš ï¸ ${warning}</div>`;
                });
            }
            
            // Tips
            if (guide.content.tips) {
                let tipsHtml = '<div class="guide-tip">';
                guide.content.tips.forEach(tip => {
                    tipsHtml += `ğŸ’¡ ${tip}<br>`;
                });
                tipsHtml += '</div>';
                modalContent += tipsHtml;
            }
            
            // é–¢é€£ã‚¬ã‚¤ãƒ‰
            if (guide.content.related_guides) {
                modalContent += `<div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(79, 172, 254, 0.3);">`;
                modalContent += `<strong>é–¢é€£ã‚¬ã‚¤ãƒ‰:</strong><br>`;
                guide.content.related_guides.forEach(relatedId => {
                    modalContent += `<div class="guide-link" onclick="showGuideInteractive('${relatedId}')">${relatedId}</div>`;
                });
                modalContent += `</div>`;
            }
            
            document.getElementById('modalTitle').innerHTML = guide.title;
            document.getElementById('modalBody').innerHTML = modalContent;
            document.getElementById('guideModal').classList.add('active');
        }

        function getDifficultyLabel(difficulty) {
            const labels = {
                'easy': 'â­ ã‹ã‚“ãŸã‚“',
                'medium': 'â­â­ ãµã¤ã†',
                'hard': 'â­â­â­ ã‚€ãšã‹ã—ã„'
            };
            return labels[difficulty] || difficulty;
        }

        function handleGenericQuery(message) {
            addMessage('ai', `ã”è³ªå•ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚

ã€Œ${message}ã€ã«ã¤ã„ã¦ã€ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹?

<div class="quick-reply-container">
    <div class="quick-reply" onclick="startSmartKeyFlow()">ğŸ”‘ ã‚¹ãƒãƒ¼ãƒˆã‚­ãƒ¼ã®å•é¡Œ</div>
    <div class="quick-reply" onclick="handleBatteryReplacement()">ğŸ”‹ é›»æ± äº¤æ›</div>
    <div class="quick-reply" onclick="showGuideInteractive('GUIDE-001')">ğŸ”§ æ©Ÿæ¢°ã‚­ãƒ¼</div>
</div>`, false);
        }

        function addMessage(sender, content, trackHistory = true) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = `chat-avatar ${sender}`;
            avatar.textContent = sender === 'ai' ? 'ğŸ¤–' : 'ğŸ‘¤';
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.innerHTML = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            
            container.scrollTop = container.scrollHeight;
            
            if (trackHistory) {
                chatHistory.push({ 
                    sender, 
                    content, 
                    timestamp: new Date(),
                    node: currentFlow.currentNode
                });
            }
        }

        function showLoading() {
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'chat-message ai';
            loadingDiv.innerHTML = `
                <div class="chat-avatar ai">ğŸ¤–</div>
                <div class="loading-indicator active">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function hideLoading() {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function updateNodeLabel(label) {
            const nodeLabel = document.getElementById('currentNodeLabel');
            if (nodeLabel) {
                nodeLabel.textContent = label;
                nodeLabel.style.color = '#4facfe';
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                nodeLabel.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    nodeLabel.style.transform = 'scale(1)';
                }, 300);
            }
        }

        function closeModal() {
            document.getElementById('guideModal').classList.remove('active');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('guideModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜
        window.saveChatHistory = function() {
            const dataStr = JSON.stringify(chatHistory, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'chat-history.json';
            link.click();
        };

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ•ãƒ­ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒˆã‚’è¡¨ç¤º
        window.showFlowState = function() {
            console.log('Current Flow State:', currentFlow);
            console.log('Chat History:', chatHistory);
        };
    </script>
</body>
</html>
