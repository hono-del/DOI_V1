# メーカーオプション対応：CSV更新計画

**作成日：** 2026年1月14日  
**バージョン：** 1.0

---

## 🎯 更新の必要性

メーカーオプションマスタの追加により、機能推奨ロジックでオプション装備の有無を判定する必要があります。そのため、以下のCSVファイルに**車両個体ID**または**車種グレードID**の列を追加する必要があります。

---

## 📊 影響を受けるCSVファイル

### **1. 機能推奨ルールマトリクス（必須）**

**ファイル：** `1-7_機能推奨ルールマトリクス_v2.csv`

#### **現状の問題**
- 車両個体IDがないため、オプション装備の判定ができない
- ルールは一般的な状況を定義しているが、個別の車両には適用できない

#### **対応方針**
ルールマトリクスは**汎用的なルール定義**として維持し、実際の推奨判定時に車両個体IDを別途入力として受け取る設計にする。

**理由：**
- ルールマトリクスは全車両に共通のロジック
- 車両個体IDは実行時のパラメータとして扱う方が柔軟

#### **実装イメージ**
```python
def recommend_feature(vehicle_id, rule_id):
    # 1. 車両個体IDから車種グレードIDを取得
    vehicle_info = get_vehicle_info(vehicle_id)
    grade_id = vehicle_info['grade_id']
    
    # 2. ルールマトリクスから推奨機能を取得
    rule = get_rule(rule_id)
    function_id = rule['function_id']
    
    # 3. 車種機能マスタで装備状況を確認
    equipment_status = get_equipment_status(grade_id, function_id)
    
    # 4. オプション装備の場合、装着有無を確認
    if equipment_status == '△':
        option_installed = check_option_installed(vehicle_id, function_id)
        if not option_installed:
            return False  # 推奨しない
    elif equipment_status == '×':
        return False  # 推奨しない
    
    # 5. 推奨ロジックを適用
    return apply_recommendation_logic(rule)
```

**結論：** ルールマトリクスCSVは変更不要

---

### **2. テストケース（更新推奨）**

**ファイル：** `1-11_テストケース_v2.csv`

#### **現状の問題**
- オプション装備のテストケースがない
- 車両個体IDがないため、オプション装備の判定をテストできない

#### **対応方針**
車両個体IDの列を追加し、オプション装備のテストケースを追加する。

#### **追加する列**
| 列名 | データ型 | 説明 | 例 |
|-----|---------|------|-----|
| 車両個体ID | テキスト | テスト対象の車両 | VEH_002 |

#### **追加するテストケース例**
```csv
テストケースID,ルールID,機能ID,車両個体ID,道路種別ID,季節ID,天気環境ID,時間帯ID,速度交通量ID,知識レベルID,使用経験ID,操作特性,推奨ロジック,期待される推奨機能,期待される最終判定,期待される優先度ランク,テスト目的
TEST_024,R007,FN006,VEH_002,ROAD_007,SEASON_001,WEATHER_001,TIME_003,SPEED_003,LEVEL_001,EXP_001,操作不要,通知不要,BSM,推奨,中,アクアG・BSM装着車でBSMを推奨することを確認
TEST_025,R007,FN006,VEH_007,ROAD_007,SEASON_001,WEATHER_001,TIME_003,SPEED_003,LEVEL_001,EXP_001,操作不要,通知不要,BSM,推奨しない,-,アクアG・BSM未装着車でBSMを推奨しないことを確認
TEST_026,R005,FN005,VEH_001,ROAD_003,SEASON_001,WEATHER_001,TIME_005,SPEED_003,LEVEL_001,EXP_001,一度ONで継続,初回のみ推奨,AHS,推奨しない,-,アクアG・AHS装備なし車でAHSを推奨しないことを確認
```

**結論：** テストケースCSVは更新が必要

---

### **3. メッセージファイル（変更不要）**

**ファイル：**
- `1-8_運転者向けメッセージ_v2.csv`
- `1-9_セールスマン向けメッセージ_v2.csv`
- `1-10_コールセンター向けメッセージ_v2.csv`

#### **現状の問題**
- 車両個体IDがないため、オプション装備に応じたメッセージを出し分けできない

#### **対応方針**
メッセージテンプレートは汎用的な内容として維持し、実際のメッセージ生成時に車両個体IDを別途入力として受け取る設計にする。

**理由：**
- メッセージテンプレートは全車両に共通
- 車両個体IDは実行時のパラメータとして扱う方が柔軟

#### **実装イメージ**
```python
def generate_message(vehicle_id, rule_id, message_template_id):
    # 1. 車両個体IDから車種グレードIDを取得
    vehicle_info = get_vehicle_info(vehicle_id)
    grade_id = vehicle_info['grade_id']
    
    # 2. ルールマトリクスから推奨機能を取得
    rule = get_rule(rule_id)
    function_id = rule['function_id']
    
    # 3. 車種機能マスタで装備状況を確認
    equipment_status = get_equipment_status(grade_id, function_id)
    
    # 4. オプション装備の場合、装着有無を確認
    if equipment_status == '△':
        option_installed = check_option_installed(vehicle_id, function_id)
        if not option_installed:
            # オプション未装着の場合は別のメッセージを返す
            return get_option_sales_message(grade_id, function_id)
    elif equipment_status == '×':
        return None  # メッセージなし
    
    # 5. メッセージテンプレートを取得して返す
    return get_message_template(message_template_id)
```

**結論：** メッセージCSVは変更不要

---

## 📋 更新が必要なCSVファイル一覧

| ファイル | 更新要否 | 理由 |
|---------|---------|------|
| 1-7_機能推奨ルールマトリクス_v2.csv | **不要** | 汎用的なルール定義として維持 |
| 1-8_運転者向けメッセージ_v2.csv | **不要** | 汎用的なメッセージテンプレートとして維持 |
| 1-9_セールスマン向けメッセージ_v2.csv | **不要** | 汎用的なメッセージテンプレートとして維持 |
| 1-10_コールセンター向けメッセージ_v2.csv | **不要** | 汎用的なメッセージテンプレートとして維持 |
| **1-11_テストケース_v2.csv** | **必要** | オプション装備のテストケースを追加 |

---

## 🔄 実装アーキテクチャ

### **データフロー**

```
┌─────────────────────┐
│  実行時入力          │
│  ・車両個体ID       │
│  ・ルールID         │
│  ・現在の状況       │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ 1. 車両情報取得      │
│  ・車種グレードID   │
│  ・ユーザー情報     │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ 2. ルール取得        │
│  ・推奨機能ID       │
│  ・推奨ロジック     │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ 3. 装備状況確認      │
│  ・車種機能マスタ   │
│  ・○/△/×         │
└──────┬──────────────┘
       │
       ├─ ○（標準装備）→ 推奨ロジックへ
       │
       ├─ △（オプション）→ メーカーオプションマスタで確認
       │                    ↓
       │                    ├─ TRUE → 推奨ロジックへ
       │                    └─ FALSE → 推奨しない
       │
       └─ ×（装備なし）→ 推奨しない
```

---

## 🎯 まとめ

### **変更不要なCSV**
- **1-7_機能推奨ルールマトリクス_v2.csv** - 汎用的なルール定義
- **1-8～1-10_メッセージ_v2.csv** - 汎用的なメッセージテンプレート

### **変更が必要なCSV**
- **1-11_テストケース_v2.csv** - 車両個体IDの列を追加し、オプション装備のテストケースを追加

### **設計思想**
- **マスタデータ** - 汎用的な定義として維持
- **実行時パラメータ** - 車両個体IDは実行時に入力
- **柔軟性** - 新しい車両や機能の追加が容易

**この設計により、CSVファイルの変更を最小限に抑えつつ、オプション装備に対応できます！**

