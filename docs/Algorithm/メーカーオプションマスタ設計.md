# メーカーオプションマスタ設計

**作成日：** 2026年1月14日  
**バージョン：** 1.0

---

## 🎯 目的

車種機能マスタで「△（メーカーオプション）」となっている機能について、各ユーザーの車両に実際に装着されているかを管理し、機能推奨ロジックで適切に判定できるようにする。

---

## 📊 マスタ構造

### **ファイル名**
`1-12_メーカーオプションマスタ_v2.csv`

### **列定義**

| 列名 | データ型 | 説明 | 例 |
|-----|---------|------|-----|
| **車両個体ID** | 文字列 | 個別の車両を識別するID | VEH_001 |
| **車種グレードID** | 文字列 | 車種機能マスタのID | CAR_001 |
| **オプション種類** | 文字列 | 装着可能なオプション機能名 | BSM, AHS, PVM, なし |
| **装着有無** | 真偽値 | 実際に装着されているか | TRUE/FALSE |
| **備考** | 文字列 | 補足情報 | アクアG・BSM装着 |

---

## 🔍 装着可能なオプション一覧

車種機能マスタで「△」となっている機能のみ装着可能：

| 車種グレードID | 車種名 | グレード | 装着可能オプション |
|-------------|--------|---------|-----------------|
| CAR_001 | アクア | G | BSM |
| CAR_002 | アクア | Z | AHS |
| CAR_007 | クラウン | RS | PVM |
| CAR_004 | ランドクルーザー250 | VX | ハンズフリーパワーバックドア |

---

## 📋 マスタデータ例

```csv
車両個体ID,車種グレードID,オプション種類,装着有無,備考
VEH_001,CAR_001,なし,FALSE,アクアG・オプションなし
VEH_002,CAR_001,BSM,TRUE,アクアG・BSM装着
VEH_003,CAR_002,なし,FALSE,アクアZ・オプションなし
VEH_004,CAR_002,AHS,TRUE,アクアZ・AHS装着
VEH_005,CAR_007,なし,FALSE,クラウンRS・オプションなし
VEH_006,CAR_007,PVM,TRUE,クラウンRS・PVM装着
VEH_007,CAR_001,BSM,FALSE,アクアG・BSM未装着
VEH_008,CAR_002,AHS,FALSE,アクアZ・AHS未装着
VEH_009,CAR_007,PVM,FALSE,クラウンRS・PVM未装着
```

---

## 🔄 機能推奨ロジックへの組み込み

### **判定フロー（V2.1対応）**

```
1. 車両個体IDを取得
   ↓
2. 機能推奨ルールマトリクスで「装備前提条件」列を確認
   ↓
   ├─ 標準装備 → 推奨ロジックへ
   └─ オプション確認必要 → 以下の確認が必要
       ↓
3. 車種グレードIDを取得（車両個体ID → 車種グレードID）
   ↓
4. 推奨したい機能IDを取得（例：FN006 = BSM）
   ↓
5. 車種機能マスタで装備状況を確認
   ↓
   ├─ ○（標準装備）→ 推奨ロジックへ
   ├─ △（オプション）→ メーカーオプションマスタで装着有無を確認
   │                    ↓
   │                    ├─ TRUE（装着あり）→ 推奨ロジックへ
   │                    └─ FALSE（装着なし）→ 推奨しない
   └─ ×（装備なし）→ 推奨しない
```

### **SQL例（イメージ）**

```sql
SELECT 
    r.ルールID,
    r.推奨機能,
    r.推奨ロジック,
    CASE 
        WHEN cf.装備状況 = '○' THEN '推奨可能'
        WHEN cf.装備状況 = '△' AND mo.装着有無 = TRUE THEN '推奨可能'
        WHEN cf.装備状況 = '△' AND mo.装着有無 = FALSE THEN '推奨不可（オプション未装着）'
        WHEN cf.装備状況 = '×' THEN '推奨不可（装備なし）'
    END AS 推奨判定
FROM 
    機能推奨ルールマトリクス r
    JOIN 車両個体 v ON v.車両個体ID = 'VEH_002'
    JOIN 車種機能マスタ cf ON cf.車種グレードID = v.車種グレードID
    LEFT JOIN メーカーオプションマスタ mo ON mo.車両個体ID = v.車両個体ID 
                                          AND mo.オプション種類 = r.推奨機能
WHERE 
    r.ルールID = 'R007'  -- BSMの推奨ルール
```

---

## 📝 具体例

### **例1：アクアG（VEH_002）でBSMを推奨する場合**

**条件：**
- 車両個体ID：VEH_002
- 車種グレードID：CAR_001（アクアG）
- 推奨機能：BSM（FN006）

**判定：**
1. 車種機能マスタでBSMを確認 → △（オプション）
2. メーカーオプションマスタで装着有無を確認 → TRUE（装着あり）
3. **結果：推奨可能** → 推奨ロジックを適用

---

### **例2：アクアG（VEH_007）でBSMを推奨する場合**

**条件：**
- 車両個体ID：VEH_007
- 車種グレードID：CAR_001（アクアG）
- 推奨機能：BSM（FN006）

**判定：**
1. 車種機能マスタでBSMを確認 → △（オプション）
2. メーカーオプションマスタで装着有無を確認 → FALSE（装着なし）
3. **結果：推奨不可** → 推奨しない

**セールスマン向けメッセージ：**
「お客様の車両（アクアG）にはBSMがオプションで追加可能です。車線変更時の安全性が向上します。次回来店時にご案内しましょう」

---

### **例3：アクアG（VEH_001）でAHSを推奨する場合**

**条件：**
- 車両個体ID：VEH_001
- 車種グレードID：CAR_001（アクアG）
- 推奨機能：AHS（FN005）

**判定：**
1. 車種機能マスタでAHSを確認 → ×（装備なし）
2. **結果：推奨不可** → 推奨しない（そもそも装着できない）

**メッセージ：**
なし（装着できない機能は推奨対象外）

---

## 🎯 セールスマン向けメッセージの拡充

オプション未装着のユーザーに対して、購入を提案するメッセージを追加：

```csv
メッセージID,車種グレードID,オプション種類,装着有無,メッセージテンプレート,チャネル,優先度
MSG_SALES_OPT_001,CAR_001,BSM,FALSE,【提案】お客様の車両（アクアG）にはBSMがオプションで追加可能です。車線変更時の安全性が向上します。次回来店時にご案内しましょう,アプリ通知,中
MSG_SALES_OPT_002,CAR_002,AHS,FALSE,【提案】お客様の車両（アクアZ）にはAHSがオプションで追加可能です。夜間の視認性が向上します。次回来店時にご案内しましょう,アプリ通知,中
MSG_SALES_OPT_003,CAR_007,PVM,FALSE,【提案】お客様の車両（クラウンRS）にはPVMがオプションで追加可能です。駐車時の安全性が向上します。次回来店時にご案内しましょう,アプリ通知,高
```

---

## 🔧 実装時の注意点

### **1. データの整合性**

- 車種機能マスタで「△」でない機能は、メーカーオプションマスタに登録できない
- 車両個体IDと車種グレードIDの関連付けが正しいこと

### **2. 「なし」の扱い**

- オプション種類が「なし」の場合は、装着有無は常にFALSE
- 「なし」は、オプションを一切装着していない車両を表す

### **3. 複数オプション装着の場合**

現在の設計では1車両1オプションですが、将来的に複数オプション装着が可能な場合は、以下のように拡張：

```csv
車両個体ID,車種グレードID,BSM装着,AHS装着,PVM装着,備考
VEH_010,CAR_001,TRUE,FALSE,FALSE,アクアG・BSM装着のみ
```

または、1車両複数行で管理：

```csv
車両個体ID,車種グレードID,オプション種類,装着有無,備考
VEH_010,CAR_001,BSM,TRUE,アクアG・BSM装着
VEH_010,CAR_001,AHS,FALSE,アクアG・AHS未装着（装着不可）
```

---

## 📊 マスタ間の関連図

```
┌─────────────────────┐
│  車両個体マスタ      │
│  ・車両個体ID       │
│  ・車種グレードID   │
│  ・ユーザーID       │
└──────┬──────────────┘
       │
       ├─────────────────────────────┐
       │                             │
       ▼                             ▼
┌─────────────────────┐    ┌─────────────────────┐
│ 車種機能マスタ       │    │ メーカーオプション   │
│ ・車種グレードID    │    │ マスタ              │
│ ・機能装備状況      │    │ ・車両個体ID        │
│   (○/△/×)         │    │ ・オプション種類     │
└─────────────────────┘    │ ・装着有無          │
                           └─────────────────────┘
                                     │
                                     ▼
                           ┌─────────────────────┐
                           │ 機能推奨ルール       │
                           │ マトリクス          │
                           │ ・推奨ロジック      │
                           └─────────────────────┘
```

---

## 🎉 まとめ

メーカーオプションマスタにより、以下が実現できます：

✅ **正確な機能推奨**
- オプション装着車両のみに推奨を行う
- 装着していない車両には推奨しない

✅ **セールス機会の創出**
- オプション未装着ユーザーに購入を提案
- 顧客満足度向上とアップセル機会

✅ **データの一貫性**
- 車種機能マスタとの連携
- 装備状況の正確な管理

