# T1～T6 プロセス整理

T1～T6 のそれぞれのプロセスについて、**どのインプットを活用し、どのように計算・処理し、どのようなアウトプット（中間 or 最終）を出すか**を整理したものです。

---

## T1：事象切り出し（Event Detection / Labeling）

**T1の処理の位置づけ**：推論ではなく、分類と整理。

---

### プロセス 1：兆候の正規化・ラベル化（Feature化）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | 困りごと選択、自由入力テキスト、写真・画像、操作ログ（失敗繰り返し・画面往復・設定失敗等）、操作間隔、文脈データ（時間帯・位置タイプ・走行状態・天候等） |
| **計算・処理** | 生の入力・ログ・センサー値を、後続で扱いやすい形に統一する。例：時刻 → time_band（day/night）、座標 → location_type（home/outside/highway）、操作ログ → 失敗回数・画面ID・間隔のラベル。テキストはキーワード抽出や意図ラベル、画像は警告灯種別などのラベルに変換。 |
| **アウトプット** | 正規化された特徴量・ラベルのセット（features）。事象候補生成の入力として渡す。 |

---

### プロセス 2：ルール＋軽い分類による事象候補生成

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1で得た正規化・ラベル化された特徴量。事前に定義したルール（例：unlock_fail >= 2 within 30s → DOOR_NOT_OPEN 候補）、キーワード／意図分類のモデル or ルール。 |
| **計算・処理** | ルールで「事象ID候補」を出す（例：DOOR_NOT_OPEN, WARNING_LAMP_ON）。キーワード・意図分類で自由文や選択テキストから候補を追加。複数候補が出る場合はそのまま次へ。 |
| **アウトプット** | 事象ID候補のリスト（1つまたは複数）。次の「兆候の重なり」で集約する対象。 |

---

### プロセス 3：兆候の重なりを集約

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス2の事象ID候補。プロセス1の特徴量（どの兆候がどの候補を支持するか）。 |
| **計算・処理** | 同一事象候補を支持する兆候をまとめる。複数候補がある場合は、支持する兆候の重なり・強さで候補を1つに絞る、または上位1つを選ぶ（ポリシーに依存）。 |
| **アウトプット** | 集約後の事象ラベル（event_id）1つ。subtype を出す場合はここで細分類も決定（警告灯種別・ドアの位置等）。confidence 算出の対象。 |

---

### プロセス 4：事象ラベルごとの確度（confidence）算出

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス3で決まった event_id（と subtype）。それを支持する兆候の種類・数・ルールのマッチ度。 |
| **計算・処理** | ルールのマッチ度や、支持する兆候の重みから「この事象として扱ってよい確度」を 0～1 で算出。しきい値未満なら事象を捨てる or 不明扱いにするポリシーも可。 |
| **アウトプット** | confidence（0～1）。T1 最終出力の一部。 |

---

### プロセス 5：UX判断用の状態情報算出（緊急度・心理リスク等）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1の context_labels（時間帯・位置・走行状態等）、event_id／subtype、confidence。事象ごとに定義した緊急度・心理リスクのルール or テーブル。 |
| **計算・処理** | event_id／subtype と context に応じて urgency（0～1）、psychological_risk（low/medium/high）をルール or テーブルで算出。evidence は「判断に使った主な兆候」のリストをまとめる。 |
| **アウトプット** | urgency、psychological_risk、context_labels（そのまま or 再整形）、evidence。T1 の最終出力として次工程へ渡す。 |

---

**T1 の最終アウトプット**：event_id、subtype（あれば）、confidence、urgency、psychological_risk、context_labels、evidence。

---

## T2：原因候補列挙（Candidate Generation）

**T2の処理の位置づけ**：原因候補の列挙と整理。

---

### プロセス 1：知識ベース検索で事象に紐づく原因を取得

| 項目 | 内容 |
|------|------|
| **活用するインプット** | T1出力の event_id、subtype（あれば）。マニュアル・FAQ・整備要領・統計などの知識ベース（故障木・トラブルシュート表）。 |
| **計算・処理** | event_id（と subtype）をキーに知識ベースを検索し、その事象で起こり得る原因のリスト（原因ID・説明）を取得。サブタイプがある場合は「警告灯種別ごとの原因」などに絞る。 |
| **アウトプット** | 事象に紐づく原因の粗いリスト（車種フィルタ前）。 |

---

### プロセス 2：車種・装備でフィルタ（その車に存在しない原因を落とす）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1の原因リスト。車種・年式・グレード・地域仕様・装備の有無（T2入力）。 |
| **計算・処理** | 各原因について「この車に存在するか」を装備・仕様で判定。該当しない原因をリストから除外。過去履歴（直近故障・交換）があれば、関連する原因を優先 or 除外するルールも可。 |
| **アウトプット** | フィルタ済みの原因候補リスト。次のメタ情報付与の対象。 |

---

### プロセス 3：各候補にメタ情報を付与（原因ID、説明、必要観察、危険度、対処群）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス2の原因候補リスト。知識ベースに登録された「必要観察」「危険度」「対処群」、またはルールで決めたデフォルト値。 |
| **計算・処理** | 各 cause_id に、description、required_observations（T3で聞く候補）、risk_level（low/medium/high）、action_group（T5で参照）を付与。 |
| **アウトプット** | cause_candidates[]（原因ID、説明、必要観察、危険度、対処群）。T2の最終出力として T3・T4 に渡す。 |

---

### プロセス 4：リストをT3・T4が参照できる形式で出力

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス3の cause_candidates[]。 |
| **計算・処理** | スキーマに沿って JSON 等に整え、T3・T4 が利用しやすい形で出力。 |
| **アウトプット** | cause_candidates[]（T2の最終出力）。 |

---

**T2 の最終アウトプット**：cause_candidates[]。

---

## T3：観察点選定（Next Best Question）

**T3の処理の位置づけ**：聞くべき1問の選定。

---

### プロセス 1：事象に紐づく原因候補（T2の出力）を取得

| 項目 | 内容 |
|------|------|
| **活用するインプット** | T2出力の cause_candidates[]。T1出力の event_id、subtype、context_labels。 |
| **計算・処理** | cause_candidates をそのまま参照。event_id／subtype で「この事象で聞くべき観察の候補」が制限されている場合は、その候補集合を用意。 |
| **アウトプット** | 観察候補の元になる原因リストと、必要観察（required_observations）の集合。次の情報利得評価の入力。 |

---

### プロセス 2：各候補質問の「情報利得」を評価（原因分布をどれだけ割れるか）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1の原因候補リストと required_observations。T3の知識（故障木・観察と原因の対応）。 |
| **計算・処理** | 各「候補質問」（例：「ランプは点きますか？」Yes/No）について、expected_split に相当する分割を想定。その質問で原因候補がどれだけ絞れるか（情報利得）を評価し、利得が大きい質問を優先。 |
| **アウトプット** | 候補質問ごとの情報利得（スコア or 順位）。次の禁則チェック・優先度調整の対象。 |

---

### プロセス 3：禁則チェック（危険・曖昧・負荷過大の質問を除外）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス2で評価した候補質問。緊急度・文脈（走行中／停止中、urgency）。禁則ルール（危険な質問・曖昧な表現・ユーザー負荷が大きい質問のリスト or ルール）。 |
| **計算・処理** | 各候補質問を禁則と照合。危険（走行中に目を離す等）・曖昧・負荷過大なものを除外。残りを「出してよい質問」に限定。 |
| **アウトプット** | 禁則をパスした候補質問のリスト。 |

---

### プロセス 4：緊急度・文脈に応じた質問順の調整（例：警告灯は色・点滅を最優先）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス3の候補質問リスト。T1の urgency、context_labels（走行中／停止中等）、event_id／subtype。事象別の「質問優先順」ルール（例：警告灯は色→点滅→走行状態）。 |
| **計算・処理** | 事象タイプと緊急度に応じて、どの質問を最初に出すかをルール or スコアで決定。情報利得が高く、かつ緊急時に必要な質問を先に。 |
| **アウトプット** | 優先順位の付いた候補質問（1問を選ぶ対象）。 |

---

### プロセス 5：1問を選び、question_text / answer_type / expected_split を生成

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス4の優先順位付き候補。テンプレート or 文言DB（question_text、answer_type）。原因候補と回答値の対応（expected_split 用）。 |
| **計算・処理** | 最優先の質問1つを選ぶ。question_id、question_text、answer_type（Yes/No、選択肢、数値、写真等）を組み立て。その質問の各回答値に対応する原因IDのリストを expected_split として生成。 |
| **アウトプット** | question_id、question_text、answer_type、expected_split、（必要なら）priority。T3の最終出力として T4（とUX）に渡す。 |

---

**T3 の最終アウトプット**：question_id、question_text、answer_type、expected_split、priority（任意）。

---

## T4：仮説評価・順位付け（Scoring / Bayesian Update）

**T4の処理の位置づけ**：確率更新と状態判定。

---

### プロセス 1：観察結果を expected_split（T3の出力）と照合し、各原因の条件一致度を算出

| 項目 | 内容 |
|------|------|
| **活用するインプット** | T3の回答（question_id、answer：Yes/No 等）。T3出力の expected_split（回答値ごとに対応する原因IDのリスト）。T2出力の cause_candidates[]。 |
| **計算・処理** | ユーザーの answer に対応する expected_split の枝を選ぶ（例：answer=No → expected_split.no）。各 cause_id について「その枝に含まれるか」で条件一致度（1 or 0、または部分一致で 0～1）を算出。複数ラウンドの観察がある場合は、各ラウンドの一致度を組み合わせる。 |
| **アウトプット** | 原因ごとの条件一致度（または尤度）。次の事後確率更新の入力。 |

---

### プロセス 2：事前確率（または前ラウンドの確率）と組み合わせて事後確率を更新

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1の条件一致度。事前確率（cause_candidates の一様 or 統計に基づく初期確率）、または前ラウンドの ranked_causes の確信度。T6から「行動失敗」が証拠として渡っている場合は、その失敗がどの原因と整合的かも考慮。 |
| **計算・処理** | ベイズ更新またはスコアリング式（事前確率 × 条件一致度 の正規化等）で、各原因の事後確率（確信度）を算出。 |
| **アウトプット** | 原因ごとの確信度（0～1）。次の順位付けの入力。 |

---

### プロセス 3：確信度で順位付けし、ranked_causes[] を生成

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス2の原因ごとの確信度。cause_id、観察で使った evidence（どの質問の回答でどう変わったか）の記録。 |
| **計算・処理** | 確信度の降順でソート。各要素に cause_id、confidence、evidence を付与して ranked_causes[] を生成。 |
| **アウトプット** | ranked_causes[]。T4の最終出力の一部。 |

---

### プロセス 4：しきい値と危険度に応じて status を決定（MORE_OBSERVATION / READY_FOR_ACTION / ESCALATE）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | ranked_causes[] の上位確信度、cause_candidates の risk_level。事象・文脈（警告灯の赤／走行中等）。しきい値（確信度が〇以上なら READY_FOR_ACTION 等）と ESCALATE 条件のルール。 |
| **計算・処理** | 上位原因の確信度が「対処に進んでよい」しきい値を超えていれば READY_FOR_ACTION。危険度が高く原因特定より安全を優先すべきなら ESCALATE。どちらでもなければ MORE_OBSERVATION。必要なら next_observation_hint を生成。 |
| **アウトプット** | status。next_observation_hint（任意）。T4の最終出力として T5（と T6 の分岐）に渡す。 |

---

**T4 の最終アウトプット**：ranked_causes[]、status、next_observation_hint（任意）。

---

## T5：行動選択（Action Planning / Decision Support）

**T5の処理の位置づけ**：選択肢の絞り込みと表現。T4の ranked_causes／status、T1の context_labels／urgency／psychological_risk、T2の risk_level を参照。

---

### プロセス 1：仮説の action_group とリスクに基づき、取り得る行動を列挙

| 項目 | 内容 |
|------|------|
| **活用するインプット** | T4の ranked_causes[] 上位の cause_id と action_group。T2の cause_candidates[].risk_level。T4の status（ESCALATE のときは安全寄りの案内）。知識ベースの「原因→推奨行動」マッピング。 |
| **計算・処理** | 上位原因の action_group から推奨行動を列挙（例：battery_replace → 電池交換、dealer → 販売店）。risk_level や status=ESCALATE に応じて「販売店推奨」等のリスク案内を付与。一次解決（今すぐ）と恒久対応を区別して候補を並べる。 |
| **アウトプット** | 取り得る行動の候補リスト（まだ絞り込み前）。 |

---

### プロセス 2：目的関数（即効性×安全×負荷×成功率）でスコア付けし、最大3つに絞る

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス1の行動候補。T1の urgency、psychological_risk、context_labels（今すぐ／屋外／深夜等）。ユーザープロファイル（DIY可否、初心者か）。各行動の所要時間・危険度・成功率の見積もり。 |
| **計算・処理** | 即効性・安全・負荷・成功率を重み付けしてスコアを算出。文脈に合わせて重みを変える（急いでいれば即効性を重視等）。スコア上位から最大3つを選ぶ。 |
| **アウトプット** | 最大3つの行動候補。次の「手順・危険注意等の付与」の対象。 |

---

### プロセス 3：一次解決と恒久対応を区別して構成

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス2の3つ以下の行動。各行動の性質（今すぐ開ける vs 電池交換 vs 販売店）。 |
| **計算・処理** | 「今すぐできること」と「きちんと直すこと」を分けて、action_cards の並びやラベルで表現。一次解決を先に、その次に恒久対応、最後にエスカレーション案の順など。 |
| **アウトプット** | 一次解決／恒久対応が分かった行動リスト（最大3）。 |

---

### プロセス 4：各行動に手順・所要時間・必要物・危険注意・代替案を付与

| 項目 | 内容 |
|------|------|
| **活用するインプット** | プロセス3の行動リスト。手順・必要物・危険注意のテンプレート or 知識ベース。T2の risk_level に基づく risk_notice（「販売店での交換を推奨」等）。 |
| **計算・処理** | 各 action_id に title、steps、duration、required_items、risk_notice、alternative を付与。テンプレートを原因・車種に合わせて具体化。 |
| **アウトプット** | action_cards[]（最大3）。T5の最終出力の一部。 |

---

### プロセス 5：escalation_option（電話/予約/ロードサービス）を必要に応じて付与

| 項目 | 内容 |
|------|------|
| **活用するインプット** | 事象・status（ESCALATE のときは必ず）。action_cards。エスカレーション先のマスタ（販売店予約、ロードサービス等）。 |
| **計算・処理** | 事象や status に応じて、電話・予約・ロードサービスなどの案内を escalation_option として付与。 |
| **アウトプット** | escalation_option。T5の最終出力として UX に渡す。 |

---

**T5 の最終アウトプット**：action_cards[]（最大3）、escalation_option。

---

## T6：結果評価・再探索（Outcome & Loop）

**T6の処理の位置づけ**：結果判定と分岐。

---

### プロセス 1：action_result と追加観察から resolved（true/false）を判定

| 項目 | 内容 |
|------|------|
| **活用するインプット** | ユーザーが答えた action_result（成功／失敗／不明）。実施した action_id。追加観察（「消えましたか？」「接続できましたか？」「再点灯したか」等の回答）。 |
| **計算・処理** | action_result が成功かつ追加観察が「解消した」なら resolved=true。失敗 or 不明 or 解消していないなら resolved=false。境界はルールで定義（不明は false 扱い等）。 |
| **アウトプット** | resolved（true/false）。以降の分岐の入力。 |

---

### プロセス 2：resolved=true の場合（一時解決か／恒久対応完了か、次のステップ誘導）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | resolved=true。実施した action_id（T5のどのカードか）。行動の性質（一時的な解決か、恒久対応か）のマッピング or ルール。事象・原因に応じた「次のステップ」のマスタ（エンジンのかけ方、電池交換ガイド等）。 |
| **計算・処理** | 実施した行動が「恒久対応」でない（例：機械キー開錠のみ）なら一時解決と判定。一時解決なら next_step=done_with_next_steps とし、next_steps_guidance（誘導するガイドのID・ラベル）を生成。恒久対応まで完了 or 事象解消なら next_step=done。 |
| **アウトプット** | next_step（done / done_with_next_steps）、next_steps_guidance（一時解決時）。 |

---

### プロセス 3：resolved=false の場合（T4に戻す／T3に戻す／エスカレーション）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | resolved=false。実施した action_id と action_result（失敗）。試行回数・これまでの T5 行動履歴。観察が足りているかどうかの判定ルール（別端末で試す等が必要か）。エスカレーションしきい値（試行回数・危険度）。 |
| **計算・処理** | **原則**：行動失敗を「新しい証拠」として T4 に渡す。next_step=retry_with_t4、evidence_from_failure（action_id、action_result、要約）を出力。**観察不足と判断したときのみ** next_step=next_question、T3用のヒントを next_question に付与。試行回数・文脈から早めにエスカレーションすべきなら next_step=escalate。 |
| **アウトプット** | next_step（retry_with_t4 / next_question / escalate）、evidence_from_failure または next_question。 |

---

### プロセス 4：エスカレーション時は handoff_payload を生成（事象、試した手順、結果の要約）

| 項目 | 内容 |
|------|------|
| **活用するインプット** | next_step=escalate。event_id（T1）。試した T5 の行動一覧と結果。T3の観察履歴（エスカレーション時に専門家へ渡す用）。 |
| **計算・処理** | event_id、actions_tried[]、result_summary をまとめ、専門家が続きを受け取りやすい最小情報で handoff_payload を生成。 |
| **アウトプット** | handoff_payload。T6の最終出力の一部。 |

---

**T6 の最終アウトプット**：resolved、next_step、next_steps_guidance（一時解決時）、evidence_from_failure または next_question（未解決時）、handoff_payload（エスカレーション時）。
