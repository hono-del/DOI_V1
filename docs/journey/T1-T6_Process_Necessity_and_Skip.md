# T1～T6 プロセスの必要性とスキップ条件

事象切り出しから**最短時間・負荷最小**で解決に導くUXを実現するため、  
各プロセスを **必須** と **条件付きスキップ可** に整理し、必要プロセスを固定するためのドキュメントです。

---

## 凡例

| 区分 | 意味 |
|------|------|
| **必須** | その事象・経路では必ず実行する。スキップ不可。 |
| **条件付きスキップ可** | 条件を満たすときだけスキップしてよい。スキップ条件を明記する。 |
| **最短パス** | ユーザー負荷を最小にしたいときの、プロセス実行の最小セット。 |

---

## 全体の方針

- **T1・T2 の「事象→原因候補」は必須**。ここを飛ばすと原因も行動も選べない。
- **T3（観察）・T4（仮説評価）は「原因がほぼ1つに決まるとき」にまとめてスキップ可能**。その場合 T2 の cause_candidates から直接 T5（行動選択）へ進む。
- **T5 の「行動を出す」は必須**。T6（結果評価）も必須だが、**その中のどの分岐（一時解決／T4戻し／エスカレーション）を実行するかは条件付き**。

---

## T1：事象切り出し

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① 兆候の正規化・ラベル化（Feature化） | **必須** | 入力がすでに構造化（困りごと選択のみ等）でも、後続の共通形式に揃えるため実行する。処理を軽くすることは可。 |
| ② ルール＋軽い分類による事象候補生成 | **必須** | event_id を決める入口。スキップ不可。 |
| ③ 兆候の重なりを集約 | **条件付きスキップ可** | **条件**：事象候補が1つのみのとき（例：困りごと選択で「ドアが開かない」のみ）。候補が1つなら集約処理はパススルーでよい。複数候補のときは必須。 |
| ④ 事象ラベルごとの確度（confidence）算出 | **必須** | 後続のしきい値判定・UX出し分けに使う。デフォルト値で代用する設計なら「実計算スキップ」は可。 |
| ⑤ UX判断用の状態情報算出（緊急度・心理リスク等） | **必須** | T5 の行動出し分けに必要。テーブル参照のみなど軽い実装でよい。 |

**T1 の最短パス**：①→②→③（候補1つのときは簡略）→④→⑤。T1 全体はスキップせず、**処理の軽量化**で対応する。

---

## T2：原因候補列挙

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① 知識ベース検索で事象に紐づく原因を取得 | **必須** | 原因候補が無いと T3/T5 に進めない。スキップ不可。 |
| ② 車種・装備でフィルタ | **条件付きスキップ可** | **条件**：車種・装備が未取得のとき、または「全車種共通」の事象のみのとき。フィルタしないで全候補を渡す。車種が取得できているときは必須。 |
| ③ 各候補にメタ情報を付与 | **必須** | T3（観察候補）・T4/T5（危険度・対処群）に必要。スキップ不可。 |
| ④ リストをT3・T4が参照できる形式で出力 | **必須** | ③の直後で形式を整えるだけなので、③と一体実装でよい。論理上は必須。 |

**T2 の最短パス**：①→②（車種なし or 共通事象のときスキップ可）→③→④。T2 全体はスキップせず実施。

---

## T3：観察点選定

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① 原因候補を取得 | **必須**（T3 を実行する場合） | T2 出力をそのまま参照。T3 自体をスキップする経路では実行しない。 |
| ② 情報利得を評価 | **必須**（T3 を実行する場合） | 質問を1つに決めるために必要。 |
| ③ 禁則チェック | **条件付きスキップ可** | **条件**：候補質問がすべて「安全・曖昧でない・負荷低」と事前定義されているとき。危険・曖昧な質問が含まれる事象では必須。 |
| ④ 質問順の調整 | **条件付きスキップ可** | **条件**：質問が1つのみ、または事象ごとのデフォルト順でよいとき。緊急度で並び替える必要がある事象（例：警告灯）では必須。 |
| ⑤ 1問と expected_split を生成 | **必須**（T3 を実行する場合） | 質問UIと T4 の入力に必要。 |

**T3 全体のスキップ**  
**条件**：原因候補が**1つだけ**かつ、その原因の確信度がしきい値以上（「ほぼこの原因」とみなせる）のとき。  
→ **T3 を実行せず、T2 の cause_candidates から直接 T4（事前確率で ranked_causes を出し）→ T5 に進む**。  
例：ユーザーが「キー電池切れの表示が出ている」と明言している場合など。

**T3 の最短パス**：T3 をやる場合は ①→②→③（安全な事象ならスキップ可）→④（質問1つのときは簡略可）→⑤。

---

## T4：仮説評価・順位付け

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① 観察結果と expected_split を照合 | **必須**（T3 の回答がある場合） | ユーザーが T3 の質問に答えたときは必ず実行。T3 をスキップした経路では、このプロセスは「観察なしで事前確率のみ」の扱いにする（実質スキップ）。 |
| ② 事前確率と組み合わせて事後確率を更新 | **必須** | 観察がない場合は事前確率（または原因1つのときは確信度1）をそのまま ranked_causes に渡す。 |
| ③ 確信度で順位付けし ranked_causes[] を生成 | **必須** | T5 がどの行動を出すかの根拠。スキップ不可。 |
| ④ status を決定 | **必須** | READY_FOR_ACTION / ESCALATE 等の分岐に必要。スキップ不可。 |

**T4 全体の「実質スキップ」**  
**条件**：T3 をスキップし、原因が1つに決まっているとき。  
→ 観察照合（①）は行わず、**原因1つで確信度1（または事前確率）の ranked_causes と status=READY_FOR_ACTION を固定で出力**し、T5 へ。

**T4 の最短パス**：T3 をスキップしたときは ②（事前のみ）→③→④。T3 を実行したときは ①→②→③→④ すべて必須。

---

## T5：行動選択

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① action_group とリスクで行動を列挙 | **必須** | 行動候補が無いとユーザーに提示できない。スキップ不可。 |
| ② 目的関数でスコア付けし最大3つに絞る | **条件付きスキップ可** | **条件**：候補が2つ以下のとき。並び順だけ決めればよい。スキップ時は「列挙順をそのまま採用」等でよい。 |
| ③ 一次解決と恒久対応を区別 | **必須** | UX 上「今すぐ」と「きちんと直す」を分けるために必要。 |
| ④ 手順・所要時間・必要物・危険注意・代替案を付与 | **必須** | 行動カードの内容として必要。 |
| ⑤ escalation_option を付与 | **条件付きスキップ可** | **条件**：status ≠ ESCALATE かつ、事象が「専門家へつなぐ選択肢」を出さない設計のとき。販売店・ロードサービスを常に出さない方針ならスキップ可。 |

**T5 の最短パス**：①→②（候補2つ以下なら簡略）→③→④→⑤（エスカレーション不要時はスキップ可）。T5 全体はスキップせず実施。

---

## T6：結果評価・再探索

| プロセス | 必要性 | スキップ条件・備考 |
|----------|--------|---------------------|
| ① resolved（true/false）を判定 | **必須** | 結果が無いと分岐できない。スキップ不可。 |
| ② resolved=true：一時解決か／次のステップ誘導 | **条件付きで実行** | **実行条件**：resolved=true のときだけ実行。false のときは実行しない（次の③へ）。スキップというより分岐。 |
| ③ resolved=false：T4戻し／T3戻し／エスカレーション | **条件付きで実行** | **実行条件**：resolved=false のときだけ実行。true のときは実行しない。 |
| ④ handoff_payload を生成 | **条件付きスキップ可** | **実行条件**：next_step=escalate のときだけ実行。done / done_with_next_steps / retry_with_t4 / next_question のときは実行しない。 |

**T6 の最短パス**：①は常に実行。②と③は **resolved の値に応じてどちらか一方のみ実行**。④は **escalate のときだけ実行**。T6 全体はスキップせず実施するが、**分岐ごとに必要なプロセスだけ実行**する。

---

## 最短・負荷最小UX のための推奨フロー

### パターンA：原因がほぼ決まっている（観察なしで行動まで進む）

- **T1**：全プロセス実行（③は候補1つのとき簡略）。
- **T2**：全プロセス実行（②は車種なし等のときスキップ可）。
- **T3**：**スキップ**（原因1つ・確信度しきい値以上）。
- **T4**：②（事前確率のみ）→③→④。①は観察なしのため実質スキップ。
- **T5**：全プロセス実行（②・⑤は条件で簡略可）。
- **T6**：①→② or ③→④（escalate のときのみ）。

### パターンB：通常（1回は観察してから行動）

- **T1**～**T2**：上記と同じ。
- **T3**：全プロセス実行（③④は条件でスキップ可）。
- **T4**：全プロセス実行。
- **T5**～**T6**：上記と同じ。

### 固定しておくべき「必要プロセス」一覧

次のプロセスは**条件に関係なく必ず必要**とする。

- **T1**：① ② ④ ⑤（③は候補1つのとき簡略可だが「実行」はする）。
- **T2**：① ③ ④（②は車種未取得等でスキップ可）。
- **T3**：T3 を実施する経路では ① ② ⑤ 必須。③④は条件付きスキップ可。T3 自体は「原因1つ・高確信」のときスキップ可。
- **T4**：② ③ ④ 必須。①は T3 をスキップしたときは実質スキップ。
- **T5**：① ③ ④ 必須。②⑤は条件付きスキップ可。
- **T6**：① 必須。②③は resolved に応じてどちらか。④は escalate のときのみ。

---

## 参照

- プロセスの中身：`T1-T6_Process_Consolidation.md`
- 事象別の具体例：`THEME_DOOR_NOT_OPEN_Process_Detail.md`
