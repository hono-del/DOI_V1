# T1～T6 実装に必要なデータとルール（プロセスエンジン）

**作成日**: 2026年2月3日  
**前提**: Thought_Function_Model_T1-T6.md、T1-T6_Process_Consolidation.md、T1-T6_Input_Consolidation.md に基づく

---

## 1. 全体像：必要なデータとエンジンの対応

| 段階 | 必要なデータ（マスタ・入力） | 必要なルール／プロセスエンジン |
|:--|:--|:--|
| **T1** | 兆候の生データ、事象ルール表、キーワード／意図マッピング | 正規化、ルールマッチ、事象集約、確度・緊急度算出 |
| **T2** | 事象→原因の知識ベース、車種・装備マスタ | 知識検索、車種フィルタ、メタ情報付与 |
| **T3** | 原因候補、故障木／観察⇔原因対応、質問文言、禁則 | 情報利得計算、禁則チェック、優先順位、1問選択 |
| **T4** | 原因候補、観察回答、expected_split、事前確率（任意） | 条件一致度、確率更新、順位付け、status判定 |
| **T5** | 原因→行動マッピング、手順・危険注意、エスカレーション先 | 行動列挙、スコア（即効性×安全×負荷×成功率）、最大3件、一次/恒久区分 |
| **T6** | 行動結果、観察履歴、試行回数・エスカレーションしきい値 | 成功判定、分岐（T4戻し／T3／エスカレーション）、handoff生成 |

---

## 2. T1：事象切り出し — 必要なデータとルール

### 2.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **兆候の生データ** | 困りごと選択、自由入力テキスト、写真、操作ログ（失敗回数・画面ID・間隔）、時刻・位置・走行状態 | ユーザー入力、車両・アプリログ、端末時刻 | アプリ/コールセンターの入力、将来は車両API |
| **事象ルール表** | 「条件 → event_id」のマッピング。例：`unlock_fail >= 2 within 30s` → DOOR_NOT_OPEN | 設計で定義、テーブル or ルールファイル | 新規整備（JourneyNode の theme_id/phase=異常検知 と対応させる想定） |
| **キーワード／意図マッピング** | 自由文・選択肢 → event_id 候補。例：「ドアが開かない」「開かない」→ DOOR_NOT_OPEN | ルール表 or 軽いNLU／意図分類 | 新規整備（NodeIntent.csv 等の拡張） |
| **事象別メタ** | event_id ごとの urgency デフォルト、psychological_risk、subtype の取り得る値 | テーブル | 新規（事象マスタ） |
| **文脈ラベル定義** | 時刻→time_band、位置→location_type、車両→走行状態 などの正規化ルール | テーブル or 定数 | 新規（コンテキスト正規化ルール） |

### 2.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **兆候の正規化** | 生入力を特徴量・ラベルに変換（操作ログ→失敗回数・画面ID、テキスト→キーワード／意図、画像→警告灯種別等） | ルール＋軽い分類（キーワードマッチ or 意図モデル） |
| **事象候補生成** | ルールマッチ（条件式評価）＋キーワード／意図から event_id 候補を列挙 | ルールエンジン（条件式の評価）、マッピングテーブル参照 |
| **兆候の集約** | 複数候補を支持する兆候の重なりで1つに絞る（または上位1つを採用） | ポリシー（最大確度／最初にマッチ等） |
| **確度（confidence）算出** | マッチしたルールの強さ・支持する兆候の数から 0～1 を算出 | 重み付きスコア、しきい値で不明扱いも可 |
| **緊急度・心理リスク** | event_id ＋ context_labels から urgency、psychological_risk を算出 | 事象マスタ＋コンテキストルールテーブル |

### 2.3 「ルール＋軽い分類による事象候補生成」で何をするか

このプロセスは**2つの経路**で事象ID候補を出します。

| 経路 | 入力 | やること | 例 |
|:--|:--|:--|:--|
| **ルール** | 操作ログ・文脈の正規化結果 | 条件式を評価し、マッチしたら event_id を候補に追加 | `unlock_fail >= 2 within 30s` → DOOR_NOT_OPEN |
| **軽い分類** | 自由文・選択テキストの正規化結果 | キーワード／意図マッチで event_id を候補に追加 | 「ドアが開かない」→ DOOR_NOT_OPEN |

複数候補が出た場合は、次の「兆候の重なりを集約」で1つに絞ります。

---

### 2.4 選択入力「ドアが開かない」のときはこのプロセスは不要か

**困りごと選択（UIで「ドアが開かない」をタップ）だけ**の入力であれば、**事象候補の「探索」は不要**です。

- 選択値と event_id は**1対1**（例：選択「ドアが開かない」→ DOOR_NOT_OPEN）なので、「候補を複数出してから集約」する必要がない。
- 実装では **「選択値 → event_id」のマッピング（参照）だけ**で事象を決め、プロセス2・3は実質スキップしてよい。
- confidence は「選択だから高い」で固定（例：0.95）か、操作ログのルールがマッチしたら少し上乗せする、程度でよい。

**次のような場合はプロセス2が役に立つ／必要になる：**

- **自由文**で「ドアが開かない」と入力された → 軽い分類（キーワード／意図）で DOOR_NOT_OPEN に結びつけるので**必要**。
- **操作ログだけ**で事象を当てたい（ユーザーが何も選んでいない）→ ルールで候補を出すので**必要**。
- 選択とログの**両方**があり、ログで確度を補強したい → ルールは「候補生成」ではなく「確度の証拠」として使う。

**まとめ**: 「ドアが開かない」が**選択入力のみ**の事例では、ルール＋軽い分類による事象候補生成は**省略してよく**、選択→event_id の1対1マッピングで十分です。

---

### 2.5 データ構造の例（事象ルール・事象マスタ）

```
事象ルール表（event_rules）
- rule_id, condition_type, condition_params（JSON等）, event_id, weight, priority

事象マスタ（event_master）
- event_id, default_urgency, default_psychological_risk, subtype_candidates（JSON）, label_ja

※ 選択入力用：ui_selection の value（例「ドアが開かない」）→ event_id のマッピングは
  event_rules（condition_type=ui_selection）または別テーブルで保持
```

---

## 3. T2：原因候補列挙 — 必要なデータとルール

### 3.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **T1出力** | event_id、subtype、context_labels | 前工程 | − |
| **事象→原因の知識ベース** | event_id（＋subtype）ごとに「起こり得る原因」のリスト。原因ID、説明、必要観察、危険度、対処群（action_group） | マニュアル・FAQ・整備要領・故障木の構造化 | JourneyNode（hypotheses、phase）、Edge の流れから抽出可能。**原因を明示した「原因マスタ」があるとよい** |
| **車種・装備マスタ** | 車種、年式、グレード、地域、装備の有無（例：スマートキー有無、警告灯種別） | 車両登録・カタログDB | 新規 or 既存車両DB |
| **原因⇔車種/装備の対応** | 「その原因が発生し得るのはどの車種・装備か」の条件 | 知識ベースに付与 or 別テーブル | 原因マスタに装備条件を付与 |
| **過去履歴（任意）** | 直近の故障・交換・利用状況、再発の有無 | 整備記録・セッション履歴 | Phase 2 以降 |

### 3.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **知識ベース検索** | event_id（＋subtype）をキーに、原因リストを取得 | テーブル検索（event_id → cause_ids） |
| **車種・装備フィルタ** | 各原因について「この車に存在するか」を判定し、該当しない原因を除外 | 条件評価（装備フラグ・年式範囲等） |
| **メタ情報付与** | 各 cause_id に description、required_observations、risk_level、action_group を付与 | 原因マスタの列をそのまま or ルールで補完 |
| **出力形式** | cause_candidates[] を T3・T4 が使うスキーマで出力 | JSON スキーマに沿った整形 |

### 3.3 データ構造の例（原因マスタ）

```
原因マスタ（cause_master）
- cause_id, event_id, subtype（任意）, description, risk_level,
  action_group（T5で参照）, required_observations（観察IDのリスト or JSON）,
  vehicle_condition（装備・年式の条件、JSON）

事象→原因（event_cause）
- event_id, cause_id, priority（表示順や事前確率のヒント）
```

既存 **JourneyNode** の `hypotheses` は「ノード（状態）ごとの仮説」なので、**事象（THEME）→ 原因リスト** に展開するマッピングを別途用意するか、Node を「原因ノード」として解釈する設計が必要。

---

## 4. T3：観察点選定 — 必要なデータとルール

### 4.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **T2出力** | cause_candidates[] | 前工程 | − |
| **故障木・観察⇔原因の対応** | 「どの質問（観察）のどの回答が、どの原因を支持／却下するか」 | 知識ベース・トラブルシュート表の構造化 | **CheckCondition.csv**（question, answers, supports）、**Edge.csv**（condition → to_id）が expected_split に相当 |
| **質問文言・回答形式** | question_id、question_text、answer_type（Yes/No、選択肢、数値、写真） | 文言マスタ | **CheckCondition.csv**（check_id, question, answer_type, answers） |
| **禁則ルール** | 危険な質問・曖昧な表現・負荷過大な質問の条件（走行中に目を離す質問等） | ルール表 | 新規（T3禁則テーブル） |
| **事象別の質問優先順** | 例：警告灯は「色→点滅→走行状態」の順で聞く | ルール表 or 優先度フィールド | CheckCondition に priority を付与 or 別テーブル |
| **取得可能な観測手段** | センサー有無、ユーザーに確認可能か、写真・数値の現実性 | 車両仕様・設計 | 新規 or 事象・質問ごとのフラグ |

### 4.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **情報利得の評価** | 各候補質問について「その回答で原因候補がどう分割されるか」を expected_split で表現し、利得が大きい質問を優先 | 原因候補リストと観察⇔原因の対応から expected_split を生成し、エントロピー減少などでスコア化 |
| **禁則チェック** | 緊急度・文脈（走行中等）と照合し、危険・曖昧・負荷過大な質問を除外 | 禁則ルールテーブルと context_labels のマッチ |
| **優先順位の調整** | 事象タイプ・緊急度に応じて「最初に出す質問」を決定 | ルール or スコア（情報利得＋優先度） |
| **1問の選択** | 優先順位の付いた候補から1問を選び、question_text、answer_type、expected_split を出力 | 最優先1件を返す |
| **expected_split の生成** | 回答値ごとに対応する cause_id のリストを付与（T4で使用） | Edge の condition_value → to_id を「原因ノード」に紐づければ、CheckCondition＋Edge から生成可能 |

### 4.3 既存CSVとの対応（T3）

- **CheckCondition.csv**: check_id ≒ question_id、question ≒ question_text、answer_type、answers。node_id で「どの状態（ノード）で聞くか」と紐づく。
- **Edge.csv**: condition（check_id）、condition_value（yes/no等）→ to_id（次ノード or guide）。  
  **expected_split** は「回答値→次ノード（＝原因／仮説に相当）」の対応として扱い、次ノードに紐づく cause_id を定義すれば、T4の「どの原因がどの枝に含まれるか」が計算できる。
- **不足しがちなデータ**: 原因ID（cause_id）とノードIDの対応、および「この質問の回答値→原因の支持/却下」の明示。JourneyNode の hypotheses を cause_id に分解するマッピングがあると実装しやすい。

---

## 5. T4：仮説評価・順位付け — 必要なデータとルール

### 5.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **T2出力** | cause_candidates[] | 前工程 | − |
| **T3の質問と回答** | question_id、answer（ユーザーが選んだ値） | ユーザー入力 | − |
| **T3の expected_split** | 回答値ごとに対応する原因IDのリスト（どの枝にどの原因が含まれるか） | T3出力 | Edge＋Node から構築 |
| **観察履歴** | 複数ラウンドの question_id / answer の蓄積 | セッション状態 | − |
| **事前確率（任意）** | 原因ごとの初期確率。未指定なら一様 | 原因マスタ or 統計 | 原因マスタに priority 等で代用可 |
| **失敗証拠（T6から戻る場合）** | 実施した action_id と結果（失敗）。どの原因と整合的か | T6出力 | − |

### 5.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **条件一致度** | ユーザーの answer に対応する expected_split の枝を選び、各 cause_id がその枝に含まれるかで 1/0 または 0～1 を付与 | 枝と cause_id の所属判定 |
| **確率更新** | 事前確率（または前ラウンドの確信度）× 条件一致度 を正規化して事後確率に。複数ラウンドは逐次更新 | ベイズ更新 or スコアリング式 |
| **順位付け** | 確信度の降順で ranked_causes[] を生成 | ソート＋evidence の付与 |
| **status 判定** | 上位確信度としきい値、risk_level、事象・文脈から READY_FOR_ACTION / MORE_OBSERVATION / ESCALATE を決定 | しきい値ルール、危険度ルール |

### 5.3 データ構造の例（T4用）

- **expected_split**: T3が出力。`{ "yes": ["cause_1", "cause_2"], "no": ["cause_3"] }` のような形。
- **しきい値**: 設定テーブル or 定数（例：top1 確信度 >= 0.7 → READY_FOR_ACTION）。

---

## 6. T5：行動選択 — 必要なデータとルール

### 6.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **T4出力** | ranked_causes[] 上位、status | 前工程 | − |
| **原因→行動マッピング** | cause_id → action_group、推奨 guide_id／action_id | 知識ベース | **Edge** の to_type=guide, to_id=GUIDE-xxx が行動（ガイド）への遷移。**Guide.csv** が手順・時間・危険度を保持 |
| **行動のメタ** | 各行動の所要時間、危険度、成功率見積もり、一次解決か恒久対応か | ガイドマスタ・設計 | **Guide.csv**（estimated_time, risk_level） |
| **エスカレーション先マスタ** | 販売店予約、ロードサービス、緊急連絡などの案内文・URL・連絡先 | マスタ | Guide の contact_service 系（GUIDE-006, 011, 012 等） |
| **T1の文脈** | context_labels、urgency、psychological_risk | T1出力 | − |
| **ユーザープロファイル（任意）** | DIY可否、初心者か、過去の選好 | ユーザーDB | Phase 2 以降 |

### 6.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **行動の列挙** | 上位原因の action_group から推奨行動を列挙。status=ESCALATE のときは安全寄りの案内を付与 | 原因マスタの action_group → guide_id のマッピング参照 |
| **スコア付け** | 即効性×安全×負荷×成功率 を重み付け。文脈（急いでいる等）で重みを変更 | スコア関数＋重みテーブル |
| **最大3件に絞る** | スコア上位から3件まで | ソート＋先頭3件 |
| **一次解決／恒久の区分** | 「今すぐできること」と「きちんと直すこと」をラベルで表現 | 行動マスタのフラグ or ルール |
| **手順・危険注意の付与** | 各 action に title、steps、duration、required_items、risk_notice、alternative を付与 | Guide の JSON やマスタを参照 |
| **escalation_option** | status=ESCALATE や事象に応じて、電話・予約・ロードサービスを付与 | エスカレーション先マスタ参照 |

### 6.3 既存CSVとの対応（T5）

- **Guide.csv**: guide_id、title、estimated_time、risk_level、notes、json_path → action_cards の元。
- **Edge.csv**: ノードから「条件なし」または「選択」で guide へ遷移する辺 → その guide が「取り得る行動」の候補。  
  **不足**: cause_id と guide_id の直接対応（現状は Node 経由で Edge で guide に飛ぶ）。**原因→推奨ガイド**のマッピングを明示したテーブルがあると T5 の列挙がしやすい。

---

## 7. T6：結果評価・再探索 — 必要なデータとルール

### 7.1 必要なデータ

| データ種別 | 内容 | 入手元・形式 | 既存資産（例） |
|:--|:--|:--|:--|
| **ユーザー回答** | action_result（成功／失敗／不明）、「消えましたか？」等の短問の回答 | ユーザー入力 | − |
| **実施した action_id** | ユーザーが選んだ T5 のカード | セッション状態 | − |
| **試した T5 の行動一覧** | セッション内の実行履歴 | セッション状態 | − |
| **T3の観察履歴** | これまでの質問と回答 | セッション状態 | − |
| **行動の性質** | 一時解決か恒久対応か、次のステップ誘導の有無 | 行動マスタ | Guide に「一時/恒久」フラグを付与 or ルール |
| **エスカレーションしきい値** | 試行回数・危険度で「もう一度観察」vs「エスカレーション」を決める条件 | ルール | 新規（設定 or 定数） |
| **次のステップ誘導** | 一時解決時の「次にやるべきガイド」のID・ラベル | マスタ | Edge で「解決→予防策」等の流れから取得可能（Guide-013 等） |

### 7.2 必要なルール・プロセスエンジン

| 処理 | 内容 | 実装のイメージ |
|:--|:--|:--|
| **resolved 判定** | action_result が成功かつ追加観察が「解消した」なら resolved=true、それ以外は false | ルール（不明は false 扱い等） |
| **一時解決時の next_steps** | 実施した行動が恒久対応でない場合、next_steps_guidance を生成 | 行動マスタの「次のガイド」参照 |
| **失敗時の分岐** | 原則は T4 に evidence_from_failure を渡して再評価。観察不足と判断したときのみ T3 へ。試行回数・危険度でエスカレーション | ルール（試行回数、status、危険度） |
| **handoff_payload 生成** | event_id、試した行動一覧、結果要約を専門家用にまとめる | テンプレート＋セッション情報の埋め込み |

---

## 8. まとめ：データ一覧とエンジン一覧

### 8.1 新規整備が望ましいデータ（マスタ・テーブル）

| データ | 用途 | 備考 |
|:--|:--|:--|
| **事象ルール表** | T1：兆候→event_id | 条件式＋event_id、重み |
| **事象マスタ** | T1：event_id ごとの urgency／risk、subtype | |
| **キーワード／意図→事象** | T1：自由文・選択→event_id 候補 | |
| **原因マスタ** | T2：cause_id、event_id、risk_level、action_group、required_observations、車種条件 | JourneyNode の hypotheses を原因ID化して整理 |
| **事象→原因** | T2：event_id → cause_ids | |
| **車種・装備マスタ** | T2：フィルタ用 | |
| **観察（質問）マスタ** | T3：question_id、question_text、answer_type、expected_split の元、禁則・優先度 | CheckCondition を拡張 or 同一 |
| **原因⇔観察の対応** | T3：expected_split の生成、情報利得計算 | Edge＋CheckCondition から構築可能 |
| **T3禁則ルール** | T3：危険・曖昧・負荷過大な質問の除外 | |
| **原因→推奨ガイド（行動）** | T5：cause_id → guide_id／action_group | Edge の流れから抽出 or 明示テーブル |
| **エスカレーション先マスタ** | T5：販売店・ロードサービス等 | Guide の contact_service と連携 |
| **行動の一時/恒久・次のステップ** | T6：next_steps_guidance | Guide または Edge で表現 |
| **T6しきい値** | 試行回数・エスカレーション条件 | 設定 or 定数 |

### 8.2 プロセスエンジン（ロジック）の一覧

| エンジン | 役割 | 入出力の要約 |
|:--|:--|:--|
| **T1 エンジン** | 兆候の正規化、ルールマッチ、事象集約、確度・緊急度算出 | 生入力 → event_id, confidence, urgency, context_labels |
| **T2 エンジン** | 知識検索、車種フィルタ、メタ付与 | event_id, 車種 → cause_candidates[] |
| **T3 エンジン** | 情報利得評価、禁則チェック、1問選択、expected_split 生成 | cause_candidates[], 履歴 → question_id, question_text, expected_split |
| **T4 エンジン** | 条件一致度、確率更新、順位付け、status 判定 | cause_candidates[], 観察回答, expected_split → ranked_causes[], status |
| **T5 エンジン** | 行動列挙、スコア付け、最大3件、手順・危険注意・エスカレーション付与 | ranked_causes[], status, 文脈 → action_cards[], escalation_option |
| **T6 エンジン** | 成功判定、分岐（T4戻し／T3／エスカレーション）、handoff 生成 | action_result, 履歴 → resolved, next_step, handoff_payload |

### 8.3 既存CSVの利用と拡張

| 既存資産 | T1～T6での利用 | 拡張・補足 |
|:--|:--|:--|
| **JourneyNode.csv** | theme_id≒事象、phase・hypotheses≒原因・状態 | cause_id を明示した原因マスタへ展開すると T2・T4 が作りやすい |
| **CheckCondition.csv** | T3 の質問文言・回答形式・node との対応 | expected_split 用に「回答値→原因」を付与 or 別テーブルで紐付け |
| **Edge.csv** | 観察→次ノード/ガイドの流れ、T3 の枝・T5 の行動候補の元 | 原因ノードと cause_id の対応を付与すると T4・T5 が明確に |
| **Guide.csv** | T5 の action_cards（手順・時間・危険度）、エスカレーション先 | 一時/恒久、次のステップ用のリンクを追加すると T6 が作りやすい |

---

以上が、T1～T6 を実装するにあたり必要な**データ**と**ルール（プロセスエンジン）**の整理です。既存の JourneyNode / CheckCondition / Edge / Guide を「故障木・トラブルシュートのグラフ」として活用しつつ、**事象・原因・観察・行動を明示したマスタとルール**を整備すると、エンジン実装と保守がしやすくなります。
