# T6：結果評価・再探索（Outcome & Loop）

## T6の定義（採用版）

**T6の役割は、  
ユーザーが実行した行動の結果を短問で確認し、  
「解決したか／していないか」を判定し、  
次の一手（T4へ戻る／T3へ戻る／解決完了／一時解決＋次のステップ誘導／エスカレーション）を決めること。**

---

## 1. T6の目的

T6は原因の再推定を行う工程ではありません。  
**「結果を最短で確認し、ループするか終了するかを決める」** ことで、  
無駄な繰り返しを減らし、必要なら専門家へ渡す **「出口の設計」** を担います。

- 成功判定：解決したかどうかを短問で取る
- **一時的な解決**（例：機械キーで開錠成功）の場合は resolved=true としつつ、**次のステップへ誘導**する（エンジンのかけ方、電池交換ガイド等）。完全に終了ではなく「恒久対応へつなぐ」出口を出す。
- **失敗時**：T4ですでに確信度の高い候補がいくつか出ているので、**原則は T4 に戻す**。行動失敗を「新しい証拠」として T4 に渡し、仮説（ranked_causes）を更新したうえで T5 が別の行動案を出す。観察が足りないと判断したときだけ T3（次の1問）に戻す。
- 専門家へ渡すときは handoff_payload（何を試したか・結果）を整える

---

## 2. T6 Input（入力）

T6が受け取るのは、実行結果と実施内容です。

### 2.1 実行結果（ユーザー回答）
- action_result：成功／失敗／不明
- 実施した action_id（T5のどのカードを選んだか）

### 2.2 追加観察（実施後の状態）
- 「消えましたか？」「接続できましたか？」などの短問の回答
- 事象によっては「再点灯したか」「走行に異常があるか」など

### 2.3 履歴（あれば）
- これまで試したT5の行動一覧
- T3の観察履歴（エスカレーション時に専門家へ渡す）

---

## 3. T6 Process（処理）

T6の処理は「結果判定と分岐」です。

1. action_result と追加観察から resolved（true/false）を判定
2. resolved=true の場合：
   - **一時的な解決**かどうかを判定（実施した行動が「恒久対応」でないか。例：機械キー開錠のみ → 一時解決）
   - 一時解決なら **next_steps_guidance** を付与し、次のステップ（エンジンのかけ方、電池交換ガイド等）へ誘導する
   - 恒久対応まで完了した／事象が解消したなら、完了フローへ（感謝・再発時の案内など）
3. resolved=false の場合：
   - **原則：T4 に戻す**。実施した行動の失敗を「新しい証拠」として T4 に渡し、仮説（ranked_causes）を更新。T4 の出力に基づき T5 が別の行動案を出す（T6 → T4 → T5 → ユーザー実行 → T6 のループ）。
   - **観察が足りないと判断したときだけ T3 に戻す**（もう1問聞いてから T4 → T5 に進みたい場合）。例：別端末で試す等、追加の観察が必要なとき。
   - 試行回数・文脈を見て、早めにエスカレーションするかも判定
4. エスカレーション時は handoff_payload を生成：事象、試した手順、結果の要約

---

## 4. T6 Output（出力）

T6は「完了か／次は何か」を出力します。

### 4.1 基本出力項目

- resolved：true / false
- next_step：
  - done：解決完了（恒久対応まで完了／事象解消）
  - **done_with_next_steps**：一時解決。次のステップ（エンジンのかけ方、電池交換等）へ誘導する
  - **retry_with_t4**：未解決。行動失敗を証拠として **T4 に戻す**。T4 が仮説を更新し、T5 が別の行動案を出す（原則のループ）
  - next_question：**T3 に戻す**（観察が足りないと判断したときのみ。next_question に T3 用の識別子やヒント）
  - escalate：専門家へ（handoff_payload を付与）
- **next_steps_guidance**（next_step=done_with_next_steps のとき）
  - 誘導する次のステップのID・ラベル・リンク（例：エンジンのかけ方、電池交換ガイド）
- handoff_payload（エスカレーション時）
  - event_id、試した行動一覧、結果の要約
  - 専門家が続きを受け取りやすくする最小情報

### 4.2 出力例

**解決した場合（恒久対応まで完了）**

```json
{
  "resolved": true,
  "next_step": "done"
}
```

**一時解決・次のステップに誘導する場合**（例：機械キーで開錠成功）

```json
{
  "resolved": true,
  "next_step": "done_with_next_steps",
  "next_steps_guidance": [
    { "id": "engine_start_guide", "label": "エンジンのかけ方", "type": "guide" },
    { "id": "battery_replace_guide", "label": "電池交換のガイド", "type": "guide" }
  ]
}
```

**未解決・T4に戻す場合**（原則。仮説を更新して別の行動案を出す）

```json
{
  "resolved": false,
  "next_step": "retry_with_t4",
  "evidence_from_failure": {
    "action_id": "A_DOOR_001",
    "action_result": "failed",
    "summary": "機械キーで解錠を試したが開かなかった"
  }
}
```

**未解決・T3に戻す場合**（観察が足りないと判断したときのみ。もう1問聞いてから T4→T5 に進む）

```json
{
  "resolved": false,
  "next_step": "next_question",
  "next_question": {
    "hint": "電波干渉の可能性",
    "suggested_observations": ["location", "other_key_result"]
  }
}
```

**エスカレーションする場合**

```json
{
  "resolved": false,
  "next_step": "escalate",
  "handoff_payload": {
    "event_id": "BT_NOT_CONNECTED",
    "actions_tried": [
      "Bluetooth OFF/ON 再接続",
      "車側で機器削除→再ペアリング",
      "端末再起動"
    ],
    "result_summary": "すべて試したが接続できず。別端末でも同様。"
  }
}
```

---

## 5. T6でやらないこと

- 原因の再推定・確率計算（T4の役割）
- 新しい観察質問の内容生成（T3が next_question のヒントを受け取り生成）
- 行動選択肢の提示（T5の役割）
- 長文の説明や診断文

T6は **結果の評価と分岐** であり、ループの制御と出口の整備が役割です。

---

## 6. 一文サマリ

**T6とは、  
実行結果を短問で確認し、  
解決完了／一時解決＋次のステップ誘導／未解決時は原則 T4 に戻して仮説更新・別行動案（T5）／観察不足時のみ T3／エスカレーションのいずれかに分岐し、  
必要なら専門家へ渡す要約を整えるための結果評価である。**
