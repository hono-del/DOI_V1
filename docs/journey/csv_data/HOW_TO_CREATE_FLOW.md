# フロー作成ガイド

## 概要

新しいテーマのフローを作成する手順を説明します。

**シンプル入力 → 自動変換 → CSV追加 → フロー図生成**

---

## ステップ1: 入力ファイルを作成

### 形式1: 記号ベース（推奨）

`THEME-XXX_input.txt`を作成:

```
テーマ: [テーマ名]
ID: THEME-XXX
緊急度: high/medium/low
インテント: I1, I2, I3

▼ [開始状態]

  ? [質問文]?
    → [選択肢1]: [次のノード名]
    → [選択肢2]: [別のノード名]

■ [ノード名]
  [GUIDE] [ガイド名]
  
  ? [次の質問]?
    → はい: [次へ]
    → いいえ: [別の次へ]

✓ 解決
  [GUIDE] 予防策
  → (終了)

⚠ エスカレーション
  [GUIDE] 連絡先
  → (終了)
```

### 記号の意味

| 記号 | 意味 | 用途 |
|:-----|:-----|:-----|
| `▼` | 開始 | フローの起点(1つだけ) |
| `■` | ノード | 状態・処理・診断 |
| `?` | 判定 | ユーザーへの質問 |
| `→` | 遷移 | 次のノードへの矢印 |
| `[GUIDE]` | ガイド | 案内コンテンツ |
| `✓` | 解決 | 成功終了 |
| `✗` | 問題 | 故障・失敗終了 |
| `⚠` | 警告 | エスカレーション終了 |

### インデント

- スペース2つで階層を表現
- 判定の選択肢は判定の下にインデント
- ノードの内容(GUIDE等)はノードの下にインデント

---

## ステップ2: 自動変換を実行

```bash
cd docs/journey/csv_data
py generate_journey_csv.py THEME-XXX_input.txt
```

### 出力

以下のファイルが自動的に更新/生成されます:

1. **JourneyNode.csv** - ノード追加
2. **CheckCondition.csv** - 判定条件追加
3. **Edge.csv** - エッジ追加
4. **Guide.csv** - ガイド追加
5. **NodeIntent.csv** - インテント追加
6. **THEME-XXX_visual_flow.html** - フロー図生成

---

## ステップ3: 確認・調整

### 3-1. フロー図で視覚確認

`THEME-XXX_visual_flow.html`をブラウザで開いて確認:

- ノードの接続は正しいか?
- 分岐は意図通りか?
- 終端ノードに到達するか?

### 3-2. CSVデータを確認

Excelでまたはテキストエディタで確認:

```bash
# Excelで開く
start JourneyNode.csv
start CheckCondition.csv
start Edge.csv
```

### 3-3. 必要に応じて手動調整

自動変換では完璧ではない場合があります。以下を手動調整:

- **フェーズ**: より適切なフェーズ名に変更
- **仮説**: hypotheses列に具体的な仮説を追加
- **インテント**: より正確なインテントに調整
- **エッジの優先度**: priority列を調整

---

## ステップ4: テスト実行

```bash
py journey_processor.py
```

サンプルジャーニーを実行して動作確認。

---

## 実例: THEME-002

### 入力ファイル: `THEME-002_input.txt`

```
テーマ: ブレーキ警告灯が点灯
ID: THEME-002
緊急度: high
インテント: I4, I5

▼ ブレーキ警告灯が点灯

  ? パーキングブレーキは解除されている?
    → いいえ: パーキングブレーキ未解除
    → はい: ブレーキ液確認

■ パーキングブレーキ未解除
  [GUIDE] パーキングブレーキ解除方法
  
  ? パーキングブレーキを解除した?
    → はい: ✓ 解決
    → いいえ: パーキングブレーキ故障

■ パーキングブレーキ故障
  [GUIDE] パーキングブレーキ故障時の対応
  → ⚠ 販売店連絡

■ ブレーキ液確認
  
  ? ブレーキ液は規定量ある?
    → はい: システム異常疑い
    → いいえ: ブレーキ液不足

... (以下略)
```

### 実行

```bash
py generate_journey_csv.py THEME-002_input.txt
```

### 出力

```
=== Journey Graph CSV Generator ===

入力ファイル: THEME-002_input.txt

テーマ: ブレーキ警告灯が点灯 (THEME-002)
ノード数: 13
判定数: 6
エッジ数: 12
ガイド数: 8

CSVに追記中...
  追加: JourneyNode.csv (13行)
  追加: CheckCondition.csv (6行)
  追加: Edge.csv (12行)
  追加: Guide.csv (8行)
  追加: NodeIntent.csv (13行)

フロー図生成中...
  生成: THEME-002_visual_flow.html

=== 完了 ===
```

### 生成されたフロー図

`THEME-002_visual_flow.html`をブラウザで開くと、インタラクティブなフロー図が表示されます。

---

## Tips & ベストプラクティス

### ✅ DO

1. **明確なノード名**
   - "パーキングブレーキ解除" ○
   - "対応" ✗

2. **具体的な質問文**
   - "パーキングブレーキは解除されていますか?" ○
   - "確認?" ✗

3. **2択を基本とする**
   - はい/いいえ
   - できる/できない

4. **ガイドは具体的に**
   - "パーキングブレーキ解除方法" ○
   - "手順" ✗

5. **終端ノードを明確に**
   - すべてのパスが ✓ ✗ ⚠ のいずれかに到達

### ❌ DON'T

1. **複雑すぎる分岐**
   - 3択以上は避ける(必要なら複数の2択に分解)

2. **無限ループ**
   - すべてのパスが終端に到達すること

3. **曖昧なノード名**
   - "確認", "対応", "診断"だけでは不明確

4. **IDの重複**
   - 各テーマで一意のIDを使用

---

## トラブルシューティング

### Q: パースエラーが出る

**A**: 以下を確認:
- メタデータ(テーマ、ID、緊急度)が正しく記述されているか
- 記号(▼ ■ ? → ✓ ✗ ⚠)が正しく使われているか
- インデントがスペース2つで統一されているか

### Q: ノードの接続がおかしい

**A**: 
- 選択肢の "→ はい: 次のノード" の書式が正しいか確認
- ノード名が完全一致しているか確認(スペースに注意)

### Q: フロー図が表示されない

**A**:
- ブラウザでJavaScriptが有効か確認
- HTMLファイルを直接ダブルクリックで開く

### Q: CSVに追加されない

**A**:
- CSVファイルが他のアプリケーション(Excel等)で開かれていないか確認
- ファイルの書き込み権限があるか確認

---

## 次のステップ

1. **新しいテーマを作成**
   - THEME-003, THEME-004... と順次作成

2. **既存テーマを拡張**
   - THEME-001やTHEME-002に分岐を追加

3. **インテント判定を調整**
   - NodeIntent.csvを手動調整して精度向上

4. **RAGシステムと連携**
   - L1データ(取扱情報)とジャーニーを接続

---

## サポート

質問や問題がある場合は、以下を確認:

1. `README.md` - 全体のシステム説明
2. `ultra_simple_template.md` - 詳細な入力形式説明
3. `CLEANUP_PLAN.md` - データ整理の方針

---

**Happy Flow Creating! 🚀**
