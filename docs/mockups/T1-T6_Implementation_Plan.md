# T1–T6 を home-screen-standalone.html に実装する進め方

`home-screen-standalone.html` に T1～T6 の仕組みを組み込み、**事象切り出しから最短・負荷最小で解決に導く** UX をシステム実装するための進め方をまとめます。

---

## 1. 現状の整理

### 1.1 モックアップのいま

| 箇所 | 内容 | T1–T6 との関係 |
|------|------|----------------|
| **ホーム** | 検索ボックス、クイック質問（ドアが開かない / Bluetooth / 警告灯）、おすすめ、よくある質問 | 「ドアが開かない」クリック → `setQuestion()` → `displayAnswer()`。静的 `qaDatabase` 参照のみ。**T1–T6 未使用**。 |
| **チャット** | `initTheme001Chat()` → 「スマートキーでドアが開かない」クイックリプライ → `startTheme001SmartKeyFlow()` | **固定スクリプト**。1メッセージで 3 択（電池 / 干渉 / 不明）→ 状況別に `handleTheme001Situation()` 等で分岐。**T2/T3/T4/T5/T6 のデータ駆動なし**。 |
| **検索** | `performSearch()` → `displayAnswer(query)` | キーワードと `qaDatabase` の一致のみ。事象ID・原因候補・観察・行動の一連フローなし。 |

→ **Theme001（ドアが開かない）は「シナリオ台本」で動いており、T1–T6 の状態・知識ベース・スキップ条件は使っていない。**

### 1.2 実装したい T1–T6 の流れ（再掲）

| 段階 | 役割 | 主な入出力（モックで使うもの） |
|------|------|------------------------------|
| **T1** | 事象切り出し | In: ユーザー選択・入力 → Out: `event_id`, `confidence`, `urgency`, `psychological_risk` 等 |
| **T2** | 原因候補列挙 | In: T1 出力 → Out: `cause_candidates[]`（原因ID・説明・必要観察・危険度・対処群） |
| **T3** | 観察点選定 | In: T2 出力 → Out: **1問** + `expected_split`。条件で**スキップ可**（原因1つ・高確信） |
| **T4** | 仮説評価・順位付け | In: 観察結果（or なし） + T2 → Out: `ranked_causes[]`, `status`（READY_FOR_ACTION / ESCALATE） |
| **T5** | 行動選択 | In: T4 出力 → Out: 行動カード（最大3つ）、一次/恒久、手順・所要時間・必要物・注意・代替・エスカレーション） |
| **T6** | 結果評価・再探索 | In: ユーザー報告（解けた/解けない） + 直前の行動 → Out: `resolved`, `next_step`（done / done_with_next_steps / retry_with_t4 / next_question / escalate） |

---

## 2. 実装の全体構成

### 2.1 三層に分ける

1. **データ層**  
   - 事象別の**モック知識ベース**（原因候補、観察質問、expected_split、行動リスト、エスカレーション先など）。  
   - まずは「ドアが開かない」用を JS オブジェクトで保持。

2. **エンジン層（T1–T6 ロジック）**  
   - `runT1()`, `runT2()`, `runT3()`, `runT4()`, `runT5()`, `runT6()` を実装。  
   - 入力は「ユーザー操作・選択」や前段の出力；出力は各定義ドキュメントのスキーマに沿ったオブジェクト。  
   - T3 スキップ条件（原因1つ & 確信度 ≥ しきい値）をここで判定。

3. **UI 層（既存モックアップへの接続）**  
   - ホームの「ドアが開かない」クリック or チャットの「スマートキーでドアが開かない」→ **T1 実行**から開始。  
   - T3 の「1問」→ チャットのクイックリプライ or 選択肢で表示。  
   - T5 の行動 → カード＋ボタンで表示。  
   - T6 の結果に応じて「完了」「次の質問」「T4 戻し」「エスカレーション」の画面を出し分け。

### 2.2 状態の持ち方

- **セッション状態**を 1 オブジェクトで保持する想定。  
  - 例: `t1Output`, `t2Output`, `t3Output`（質問・expected_split）, `observationResult`, `t4Output`, `t5Output`, `currentStep`（'t3_question' | 't5_actions' | 't6_result' など）。  
- 同一タブ内で「ドアが開かない」フローを 1 本に限定するなら、グローバル変数でも可。複数事象やタブを考慮するなら名前空間（例: `T16State.byTheme['DOOR_NOT_OPEN']`）を推奨。

---

## 3. 段階別の進め方（フェーズ）

### フェーズ 1：データ層 + エンジン骨子 + 「ドアが開かない」のみ接続

**目的**: T1–T6 が 1 本のパイプラインとして動き、既存 UI に「ドアが開かない」で繋がるようにする。

| # | やること | 詳細 |
|---|----------|------|
| 1.1 | **モック知識ベースの用意** | `DOOR_NOT_OPEN` 用に、`cause_candidates`（T2 出力想定）、T3 用の「観察質問リスト」と `expected_split`、T5 用の行動リスト（action_group・手順・必要物・危険注意・代替・escalation_option）を JS オブジェクトで定義。`THEME_DOOR_NOT_OPEN_Process_Detail.md` の表をそのままデータ化してよい。 |
| 1.2 | **T1 モック実装** | 入力: 「ドアが開かない」選択 or 文言。出力: `event_id: 'DOOR_NOT_OPEN'`, `confidence`, `urgency`, `psychological_risk` 等。自由入力は後回しで、選択だけで固定出力でよい。 |
| 1.3 | **T2 モック実装** | 入力: T1 出力。知識ベースから `cause_candidates[]` を返す。車種フィルタは省略可。 |
| 1.4 | **T3 モック実装** | 入力: T2 出力。原因候補と知識ベースから「1問」と `expected_split` を返す。情報利得は簡易（例: 最初の 1 問を固定）でよい。 |
| 1.5 | **T4 モック実装** | 入力: 観察結果（Yes/No など）+ T2 出力 + T3 の `expected_split`。事後確率は簡易計算 or テーブルで可。出力: `ranked_causes[]`, `status`。 |
| 1.6 | **T5 モック実装** | 入力: T4 出力。`ranked_causes` の top の `action_group` 等から行動を列挙し、最大3つ・一次/恒久・手順等を付与。出力: 行動リスト（表示用）。 |
| 1.7 | **T6 モック実装** | 入力: ユーザー報告（解けた / 解けない）+ 実行した行動。出力: `resolved`, `next_step`。ルール or 簡易分岐でよい。 |
| 1.8 | **UI 接続（入口）** | ホームの「ドアが開かない」クリック or チャットの「スマートキーでドアが開かない」→ T1 → T2 を実行。T3 スキップはまだ使わず、**常に T3 を 1 回実行**する経路でよい。 |
| 1.9 | **UI 接続（T3 → T4 → T5）** | T3 の「1問」をチャットに表示。ユーザーが選択 → 観察結果として T4 へ → T4 → T5 を実行し、T5 の行動をカードで表示。 |
| 1.10 | **UI 接続（T6）** | ユーザーが「試した」結果（解けた/解けない）を入力 → T6 実行 → `next_step` に応じて「完了」「次の質問」「T4 戻し」「エスカレーション」を表示。 |

**完了基準**: 「ドアが開かない」を選ぶと、T1→T2→T3（1問）→回答→T4→T5（行動表示）→結果報告→T6 で次の一手まで表示される。

---

### フェーズ 2：T3 スキップ（最短パス）の組み込み

**目的**: 原因が 1 つに決まっているときは T3 を飛ばし、T2 → T4（事前確率のみ）→ T5 で行動まで一気に出す。

| # | やること | 詳細 |
|---|----------|------|
| 2.1 | **T3 スキップ条件の実装** | T2 出力で `cause_candidates.length === 1` かつ 確信度（または事前確率）≥ しきい値 → T3 をスキップ。しきい値は定数で定義（例: 0.8）。 |
| 2.2 | **エントリの拡張（任意）** | ユーザーが「キー電池切れの表示が出ている」等を選んだ場合、T1 で subtype やキーワードを渡し、T2 で原因を 1 つに絞る（または最初から原因1件のデータを返す）。その経路で T3 スキップが発生するようにする。 |
| 2.3 | **UI の出し分け** | T3 スキップ時は「観察の1問」を出さず、いきなり T4（事前のみ）→ T5 の行動カードを表示。 |

**完了基準**: 原因1つ・高確信の経路で、質問なしで行動案が表示される。

**実装済み（Phase 2）**  
- しきい値 `T3_SKIP_CONFIDENCE_THRESHOLD = 0.8` を定義。T2 で `cause_candidates.length === 1` かつ T1 の `confidence >= しきい値` のとき T3 をスキップ。  
- T1：入力に「キー電池切れの表示」「電池切れの表示」等が含まれるとき `subtype: 'battery_indicator'`, `confidence: 0.95` を返す。T2：`subtype === 'battery_indicator'` のとき原因を KEY_BATTERY_EMPTY のみに絞る。  
- T3 スキップ時は「原因が特定できました。次の対処をご案内します。」のうえで T4（事前のみ）→ T5 の行動カードを直接表示。チャットに「キー電池切れの表示が出ている」クイックリプライを追加し、最短パスを試せるようにした。

---

### フェーズ 3：既存 Theme001 スクリプトの置き換えと UX 調整 ✅ 完了

**目的**: ハードコードされた `startTheme001SmartKeyFlow` 等を、T1–T6 駆動の 1 本に統一し、見た目を維持・改善する。

| # | やること | 詳細 |
|---|----------|------|
| 3.1 | **Theme001 の入口を T1 に統一** | 「スマートキーでドアが開かない」クリック時、`startTheme001SmartKeyFlow()` の代わりに「T1 実行 → T2 → T3 またはスキップ → …」を呼ぶ。 |
| 3.2 | **メッセージ文のデータ化** | これまで `addTheme001Message('ai', ...)` に直書きしていた説明文を、知識ベース or メッセージテンプレート（事象ID・原因ID・行動ID キー）から組み立てる。 |
| 3.3 | **検索からの連携（任意）** | ホームの検索で「ドアが開かない」と入力して検索した場合も、T1 を発火させて同じ T1–T6 フローに乗せる。 |

**完了基準**: チャットでもホームのクイック質問でも、同じ T1–T6 パイプラインとデータで動き、表示が破綻しない。

**実装済み（Phase 3）**  
- **public/index.html** に T16 知識ベース（T16_KB_DOOR_NOT_OPEN）、runT1～runT6、startT16DoorNotOpenFlow／handleT16T3Answer／handleT16ActionClick／handleT16BatteryReplaceChoice／handleT16T6Result を追加。  
- チャット初期メッセージを T1–T6 駆動に統一：`initTheme001Chat()` のクイックリプライを `startT16DoorNotOpenFlow('スマートキーでドアが開かない')` および `startT16DoorNotOpenFlow('キー電池切れの表示が出ている')` に変更。  
- 検索連携：`performSearch()` で「ドアが開かない」を含む検索時はチャットタブへ切り替え（`switchToChatTabProgrammatic(true)`）し、`startT16DoorNotOpenFlow(query)` で T1–T6 フローを開始。  
- `showChatScreen(options)` に `skipInit` オプションを追加し、検索からチャットへ遷移する際は初期メッセージを出さずに T16 フローのみ表示。

---

### フェーズ 4（任意）：他事象・API 化

- **他事象**: 「警告灯が点灯」等、別の `event_id` 用に知識ベースを追加し、T1 の出力 `event_id` に応じて T2 以降のデータを切り替える。
- **API 化**: T2/T3/T4/T5 を将来バックエンド API に置き換える場合、エンジン層のインターフェース（入力・出力の形）を変えず、内部だけ `fetch` に差し替える。

---

## 4. ファイル・コードの置き場所

| 内容 | 方針 |
|------|------|
| **当面** | すべて `home-screen-standalone.html` 内に記述。データは `<script>` 内のオブジェクト、エンジンは `function runT1(...)` 等の関数群、UI は既存の `addTheme001Message` 等を T1–T6 の出力で駆動するように変更。 |
| **見通しが悪くなった場合** | モック知識ベースを `mockup-data-door-not-open.js`、T1–T6 エンジンを `t16-engine.js` のように切り出し、HTML から `<script src="...">` で読み込む構成にすると、仕様ドキュメントとの対応が取りやすい。 |

---

## 5. UI と T1–T6 の対応表（実装時の参照用）

| T1–T6 の出力 | モックアップでの表現 |
|--------------|----------------------|
| T1 完了 | 事象が決まったことを内部状態に保持。必要なら「〇〇ですね。確認させてください」の 1 メッセージ。 |
| T3 の 1 問 + expected_split | チャットの AI メッセージ＋クイックリプライ（Yes/No や 3 択）。選択結果を `observationResult` として T4 へ。 |
| T4 の status = ESCALATE | 行動案の代わり or 追加で「販売店・ロードサービスへ」を表示。 |
| T5 の行動リスト | カード＋ボタン（一次対応 / 恒久対応 / エスカレーション）。各行動に **guide_id**（取扱説明書由来ガイドID）を紐づけ。例：A_DOOR_001→GUIDE-001（機械キーの取り出し方）、A_DOOR_002→GUIDE-005（電池交換手順）。`docs/journey/csv_data/XML_GUIDE_INTEGRATION_SUMMARY.md` 参照。**電池交換（A_DOOR_002）**は risk_notice 表示後「販売店で交換する」「自分で交換する」の選択ステップを挟む。 |
| T6 の next_step | `done` → 完了メッセージ；`done_with_next_steps` → 完了＋次にやること；`retry_with_t4` → 次の観察 or 別行動案；`next_question` → T3 の次の 1 問；`escalate` → 連絡先・handoff 表示。 |

---

## 6. 参照ドキュメント

| ドキュメント | 用途 |
|--------------|------|
| `docs/journey/Thought_Function_Model_T1-T6.md` | T1–T6 の I/O と役割の全体像 |
| `docs/journey/T1-T6_Process_Consolidation.md` | 各プロセスのインプット・計算・アウトプット |
| `docs/journey/T1-T6_Process_Necessity_and_Skip.md` | 必須／スキップ条件・最短パス |
| `docs/journey/THEME_DOOR_NOT_OPEN_Process_Detail.md` | 「ドアが開かない」の T1–T6 具体値（データ化の元） |
| `docs/journey/T1_Event_Detection_Definition.md` ～ `T6_Outcome_Evaluation_Definition.md` | 各段階の正式な入出力定義 |

---

## 7. 進め方のまとめ（チェックリスト）

1. **フェーズ 1**: モック知識ベース（ドアが開かない）→ runT1～runT6 の実装 → ホーム/チャットの「ドアが開かない」を T1 から接続 → T3 の 1 問表示 → T4→T5 で行動表示 → T6 で結果分岐まで一通り動かす。  
2. **フェーズ 2**: T3 スキップ条件（原因1つ・高確信）を入れ、最短パスで行動まで出るようにする。  
3. **フェーズ 3**: 既存 Theme001 のハードコードを T1–T6 駆動に置き換え、メッセージをデータ化する。  
4. **フェーズ 4（任意）**: 他事象や API 化。

この順で進めれば、**事象切り出しから最短・負荷最小で解決に導く** UX を、`home-screen-standalone.html` 上でシステムとして実装できます。
